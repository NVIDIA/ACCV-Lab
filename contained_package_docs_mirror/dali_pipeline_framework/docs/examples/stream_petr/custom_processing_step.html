

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Processing Step: StreamPETRDataCombiner &mdash; ACCV-Lab 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/custom.css?v=9282052d" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="Custom Post-Processing" href="custom_post_processing.html" />
    <link rel="prev" title="StreamPETR Pipeline Setup" href="pipeline_setup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            ACCV-Lab
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../project_overview/README.html">ACCV-Lab Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../guides_index.html">Guides</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contained Packages</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../on_demand_video_decoder/docs/index.html">On Demand Video Decoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../batching_helpers/docs/index.html">Batching Helpers</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">DALI Pipeline Framework</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../design.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/main_api.html">Main API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/additional_api.html">Additional API Reference</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../examples.html">Examples</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../../examples.html#pipeline-setup-examples">Pipeline Setup Examples</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../2d_object_detection/index.html">2D Object Detection Pipeline</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html">StreamPETR Pipeline</a><ul class="current">
<li class="toctree-l5"><a class="reference internal" href="pipeline_setup.html">StreamPETR Pipeline Setup</a></li>
<li class="toctree-l5 current"><a class="current reference internal" href="#">Custom Processing Step: <code class="docutils literal notranslate"><span class="pre">StreamPETRDataCombiner</span></code></a></li>
<li class="toctree-l5"><a class="reference internal" href="custom_post_processing.html">Custom Post-Processing</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../flexible_step/index.html">Flexible Step Implementation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../examples.html#data-loaders-for-nuscenes">Data Loaders for NuScenes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../evaluation.html">Evaluation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../draw_heatmap/docs/index.html">Draw Heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../optim_test_tools/docs/index.html">Optimization Testing Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">ACCV-Lab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">DALI Pipeline Framework</a></li>
          <li class="breadcrumb-item"><a href="../../examples.html">Examples</a></li>
          <li class="breadcrumb-item"><a href="index.html">StreamPETR Pipeline</a></li>
      <li class="breadcrumb-item active">Custom Processing Step: <code class="docutils literal notranslate"><span class="pre">StreamPETRDataCombiner</span></code></li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../_sources/contained_package_docs_mirror/dali_pipeline_framework/docs/examples/stream_petr/custom_processing_step.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="custom-processing-step-streampetrdatacombiner">
<h1>Custom Processing Step: <code class="docutils literal notranslate"><span class="pre">StreamPETRDataCombiner</span></code><a class="headerlink" href="#custom-processing-step-streampetrdatacombiner" title="Link to this heading"></a></h1>
<p>This page documents the custom processing step <code class="docutils literal notranslate"><span class="pre">StreamPETRDataCombiner</span></code> used by the StreamPETR pipeline.
It prepares images, camera geometry and (optionally) ground truth into tensors close to the format expected
by StreamPETR training, minimizing the work required in the post‑processing function (see
<a class="reference internal" href="custom_post_processing.html"><span class="doc">Custom Post-Processing</span></a>).</p>
<section id="overview-and-goals">
<h2>Overview and Goals<a class="headerlink" href="#overview-and-goals" title="Link to this heading"></a></h2>
<div class="docutils container">
<p>Here, we define a processing step that is used to convert the format of the data to a format close to the
format expected by the StreamPETR training.</p>
<p>Note that the final format cannot be exactly matched, as it contains some framework-specific data types, which
are not supported by DALI.</p>
<p>However, it is advisable to bring the format as close as feasible to the final format within the DALI
pipeline. While a post-processing step can be used to bridge the remaining gap, processing within the DALI
pipeline is preferable for performance reasons. The post-processing step runs in the main training thread,
and therefore, it should be kept as light-weight as possible, ideally only containing type conversions or
reshaping operations, no actual data processing.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Please also see the <a class="reference internal" href="../flexible_step/index.html"><span class="doc">Flexible Step Implementation</span></a> page for a general introduction on how to implement
custom processing steps.</p>
</div>
</section>
<section id="details">
<h2>Details<a class="headerlink" href="#details" title="Link to this heading"></a></h2>
<p>Here, we discuss the details of the <code class="docutils literal notranslate"><span class="pre">StreamPETRDataCombiner</span></code> custom processing step.</p>
<section id="add-and-initialize-output-fields">
<h3>Add and Initialize Output Fields<a class="headerlink" href="#add-and-initialize-output-fields" title="Link to this heading"></a></h3>
<p>New fields are added to hold combined tensors while original fields remain available during conversion.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">packages/dali_pipeline_framework/examples/pipeline_setup/additional_impl/processing_steps/stream_petr_data_combiner.py</span><a class="headerlink" href="#id1" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 95</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SampleDataGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SampleDataGroup</span><span class="p">:</span>
<span class="linenos"> 96</span>        <span class="c1"># ===== Add and initialize output fields =====</span>
<span class="hll"><span class="linenos"> 97</span>        <span class="c1"># @NOTE Add new fields where the converted data will be stored. Original fields remain available</span>
</span><span class="hll"><span class="linenos"> 98</span>        <span class="c1"># during conversion to allow referencing them while populating the new fields.</span>
</span><span class="hll"><span class="linenos"> 99</span>        <span class="c1"># Some fields will be direct references; others are converted/stacked first.</span>
</span><span class="linenos">100</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_new_fields</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">101</span>
</pre></div>
</div>
</div>
</section>
<section id="combine-camera-images">
<h3>Combine Camera Images<a class="headerlink" href="#combine-camera-images" title="Link to this heading"></a></h3>
<p>Per‑camera images are transposed to channel‑first (C,H,W) and stacked across cameras.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">packages/dali_pipeline_framework/examples/pipeline_setup/additional_impl/processing_steps/stream_petr_data_combiner.py</span><a class="headerlink" href="#id2" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">102</span>        <span class="c1"># ===== Combine camera images =====</span>
<span class="hll"><span class="linenos">103</span>        <span class="c1"># @NOTE Transpose per‑camera images to channel‑first (C,H,W), then stack across cameras into one tensor</span>
</span><span class="hll"><span class="linenos">104</span>        <span class="c1"># with camera axis first (axis_name &#39;V&#39;).</span>
</span><span class="linenos">105</span>        <span class="n">num_cams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">])</span>
<span class="linenos">106</span>
<span class="linenos">107</span>        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">108</span>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cams</span><span class="p">):</span>
<span class="linenos">109</span>            <span class="n">curr_image</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
<span class="linenos">110</span>            <span class="n">curr_image_channels_outer</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">curr_image</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="linenos">111</span>            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_image_channels_outer</span><span class="p">)</span>
<span class="linenos">112</span>        <span class="n">images_block</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="o">*</span><span class="n">images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;V&quot;</span><span class="p">)</span>
<span class="linenos">113</span>
</pre></div>
</div>
</div>
</section>
<section id="adjust-and-combine-projection-geometry">
<h3>Adjust and Combine Projection Geometry<a class="headerlink" href="#adjust-and-combine-projection-geometry" title="Link to this heading"></a></h3>
<p>Matrices are padded to homogeneous 4×4 where necessary and stacked across cameras.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">packages/dali_pipeline_framework/examples/pipeline_setup/additional_impl/processing_steps/stream_petr_data_combiner.py</span><a class="headerlink" href="#id3" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">114</span>        <span class="c1"># ===== Adjust and combine projection geometry =====</span>
<span class="hll"><span class="linenos">115</span>        <span class="c1"># @NOTE Pad per‑camera matrices to homogeneous 4×4 where needed (intrinsics), and append homogeneous</span>
</span><span class="hll"><span class="linenos">116</span>        <span class="c1"># bottom row to lidar2img. Then stack across cameras.</span>
</span><span class="linenos">117</span>
<span class="linenos">118</span>        <span class="c1"># Define constants used to pad matrices to homogeneous 4×4 form</span>
<span class="linenos">119</span>        <span class="n">last_matrix_row</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
<span class="linenos">120</span>            <span class="n">fdata</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">DALIDataType</span><span class="o">.</span><span class="n">FLOAT</span>
<span class="linenos">121</span>        <span class="p">)</span>
<span class="linenos">122</span>        <span class="n">col_zeros_3</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">fdata</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">DALIDataType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">)</span>
<span class="linenos">123</span>
<span class="linenos">124</span>        <span class="c1"># Combine lidar2img, extrinsics, and intrinsics (for now as a list) &amp; add padding as needed</span>
<span class="linenos">125</span>        <span class="n">all_lidar2img</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_cams</span>
<span class="linenos">126</span>        <span class="n">all_extr</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_cams</span>
<span class="linenos">127</span>        <span class="n">all_intr</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_cams</span>
<span class="linenos">128</span>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cams</span><span class="p">):</span>
<span class="linenos">129</span>            <span class="n">curr_cam_geometry</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="s2">&quot;cam_geometry&quot;</span><span class="p">]</span>
<span class="linenos">130</span>            <span class="n">curr_lidar2img</span> <span class="o">=</span> <span class="n">curr_cam_geometry</span><span class="p">[</span><span class="s2">&quot;lidar2img&quot;</span><span class="p">]</span>
<span class="linenos">131</span>            <span class="n">curr_extr</span> <span class="o">=</span> <span class="n">curr_cam_geometry</span><span class="p">[</span><span class="s2">&quot;extr_lidar2img&quot;</span><span class="p">]</span>
<span class="linenos">132</span>            <span class="n">curr_intr</span> <span class="o">=</span> <span class="n">curr_cam_geometry</span><span class="p">[</span><span class="s2">&quot;intr_lidar2img&quot;</span><span class="p">]</span>
<span class="linenos">133</span>
<span class="linenos">134</span>            <span class="c1"># Append a homogeneous bottom row to lidar2img</span>
<span class="linenos">135</span>            <span class="n">curr_lidar2img</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">curr_lidar2img</span><span class="p">,</span> <span class="n">last_matrix_row</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">136</span>
<span class="linenos">137</span>            <span class="c1"># Pad intrinsics to 4×4 by adding a zero column and a homogeneous bottom row</span>
<span class="linenos">138</span>            <span class="n">curr_intr</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">curr_intr</span><span class="p">,</span> <span class="n">col_zeros_3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">139</span>            <span class="n">curr_intr</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">curr_intr</span><span class="p">,</span> <span class="n">last_matrix_row</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">140</span>
<span class="linenos">141</span>            <span class="n">all_lidar2img</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_lidar2img</span>
<span class="linenos">142</span>            <span class="n">all_extr</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_extr</span>
<span class="linenos">143</span>            <span class="n">all_intr</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_intr</span>
<span class="linenos">144</span>
<span class="linenos">145</span>        <span class="c1"># Combine the data from all cameras into single tensors (stack across cameras)</span>
<span class="linenos">146</span>        <span class="n">lidar2img_block</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="o">*</span><span class="n">all_lidar2img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">147</span>        <span class="n">extrinsics_block</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="o">*</span><span class="n">all_extr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">148</span>        <span class="n">intrinsics_block</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="o">*</span><span class="n">all_intr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">149</span>
<span class="linenos">150</span>        <span class="c1"># Combine camera timestamps into a single tensor (stack across cameras)</span>
<span class="linenos">151</span>        <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_cams</span>
<span class="linenos">152</span>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cams</span><span class="p">):</span>
<span class="linenos">153</span>            <span class="n">timestamps</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
<span class="linenos">154</span>        <span class="n">timestamps_block</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="o">*</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">155</span>
</pre></div>
</div>
</div>
</section>
<section id="store-combined-tensors">
<h3>Store Combined Tensors<a class="headerlink" href="#store-combined-tensors" title="Link to this heading"></a></h3>
<p>Combined images, geometry, ego poses, and timestamps are stored in the new fields.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">packages/dali_pipeline_framework/examples/pipeline_setup/additional_impl/processing_steps/stream_petr_data_combiner.py</span><a class="headerlink" href="#id4" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">156</span>        <span class="c1"># ===== Store combined tensors =====</span>
<span class="hll"><span class="linenos">157</span>        <span class="c1"># @NOTE Store combined images, projection geometry, ego poses, and timestamps in the newly added</span>
</span><span class="hll"><span class="linenos">158</span>        <span class="c1"># fields.</span>
</span><span class="linenos">159</span>        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">images_block</span>
<span class="linenos">160</span>        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lidar2img&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lidar2img_block</span>
<span class="linenos">161</span>        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;intrinsics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intrinsics_block</span>
<span class="linenos">162</span>        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;extrinsics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extrinsics_block</span>
<span class="linenos">163</span>        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ego_pose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ego_pose_geom&quot;</span><span class="p">][</span><span class="s2">&quot;lidar_ego_pose&quot;</span><span class="p">]</span>
<span class="linenos">164</span>        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ego_pose_inv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ego_pose_geom&quot;</span><span class="p">][</span><span class="s2">&quot;lidar_ego_pose_inv&quot;</span><span class="p">]</span>
<span class="linenos">165</span>        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;img_timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamps_block</span>
<span class="linenos">166</span>
</pre></div>
</div>
</div>
</section>
<section id="process-ground-truth">
<h3>Process Ground Truth<a class="headerlink" href="#process-ground-truth" title="Link to this heading"></a></h3>
<p>The 3D bounding boxes are converted to the training layout, angles wrapped, NaNs removed; per‑camera 2D GT is
padded and stacked with per‑camera object counts.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">packages/dali_pipeline_framework/examples/pipeline_setup/additional_impl/processing_steps/stream_petr_data_combiner.py</span><a class="headerlink" href="#id5" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">167</span>        <span class="c1"># ===== Process ground truth =====</span>
<span class="hll"><span class="linenos">168</span>        <span class="c1"># @NOTE If ground truth is included, convert 3D boxes to the training layout and stack per‑camera 2D</span>
</span><span class="hll"><span class="linenos">169</span>        <span class="c1"># GT. Also, replace NaNs, wrap angles to `[−pi, pi]`.</span>
</span><span class="hll"><span class="linenos">170</span>        <span class="c1">#</span>
</span><span class="hll"><span class="linenos">171</span>        <span class="c1"># Note that to combine the per-camera 2D GT, we need to pad the data to a common size. In order</span>
</span><span class="hll"><span class="linenos">172</span>        <span class="c1"># to know the number of valid objects per camera after padding, we additionally store the number of</span>
</span><span class="hll"><span class="linenos">173</span>        <span class="c1"># objects (i.e. the size of the data before padding).</span>
</span><span class="linenos">174</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_ground_truth_included</span><span class="p">:</span>
<span class="linenos">175</span>            <span class="c1"># Adjust ground-truth bounding boxes.</span>
<span class="linenos">176</span>            <span class="n">gt_boxes_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gt_boxes&quot;</span><span class="p">]</span>
<span class="linenos">177</span>            <span class="n">sizes</span> <span class="o">=</span> <span class="n">gt_boxes_data</span><span class="p">[</span><span class="s2">&quot;sizes&quot;</span><span class="p">]</span>
<span class="linenos">178</span>            <span class="c1"># Add the translation offset to the translations</span>
<span class="linenos">179</span>            <span class="n">translations</span> <span class="o">=</span> <span class="n">gt_boxes_data</span><span class="p">[</span><span class="s2">&quot;translations&quot;</span><span class="p">]</span>
<span class="linenos">180</span>            <span class="n">translations</span> <span class="o">=</span> <span class="n">translations</span> <span class="o">+</span> <span class="n">sizes</span> <span class="o">*</span> <span class="n">fn</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
<span class="linenos">181</span>                <span class="n">fdata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounding_box_offset_rel_box_size</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">DALIDataType</span><span class="o">.</span><span class="n">FLOAT</span>
<span class="linenos">182</span>            <span class="p">)</span>
<span class="linenos">183</span>
<span class="linenos">184</span>            <span class="c1"># Reorder the size dimensions to the expected format</span>
<span class="linenos">185</span>            <span class="n">sizes_reordered</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">sizes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sizes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sizes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">186</span>
<span class="linenos">187</span>            <span class="c1"># Get the orientation and velocity</span>
<span class="linenos">188</span>            <span class="n">orientations</span> <span class="o">=</span> <span class="n">gt_boxes_data</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">]</span>
<span class="linenos">189</span>            <span class="n">velocities</span> <span class="o">=</span> <span class="n">gt_boxes_data</span><span class="p">[</span><span class="s2">&quot;velocities&quot;</span><span class="p">]</span>
<span class="linenos">190</span>
<span class="linenos">191</span>            <span class="c1"># Wrap orientation to the expected range [-π, π]</span>
<span class="linenos">192</span>            <span class="n">orientations</span> <span class="o">=</span> <span class="n">numba_op</span><span class="o">.</span><span class="n">ensure_range</span><span class="p">(</span>
<span class="linenos">193</span>                <span class="n">orientations</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DALIDataType</span><span class="o">.</span><span class="n">FLOAT</span>
<span class="linenos">194</span>            <span class="p">)</span>
<span class="linenos">195</span>            <span class="c1"># Combine the bounding box data into a single tensor</span>
<span class="linenos">196</span>            <span class="n">bounding_boxes</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<span class="linenos">197</span>                <span class="n">translations</span><span class="p">,</span>
<span class="linenos">198</span>                <span class="n">sizes_reordered</span><span class="p">,</span>
<span class="linenos">199</span>                <span class="n">fn</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="linenos">200</span>                <span class="n">velocities</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span>
<span class="linenos">201</span>                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">202</span>            <span class="p">)</span>
<span class="linenos">203</span>            <span class="c1"># Replace NaNs with 0</span>
<span class="linenos">204</span>            <span class="n">bounding_boxes</span> <span class="o">=</span> <span class="n">numba_op</span><span class="o">.</span><span class="n">replace_nans</span><span class="p">(</span><span class="n">bounding_boxes</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos">205</span>            <span class="c1"># Get the number of objects (needed because tensors are padded to common sizes)</span>
<span class="linenos">206</span>            <span class="n">num_bboxes</span> <span class="o">=</span> <span class="n">bounding_boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">207</span>
<span class="linenos">208</span>            <span class="c1"># Store results</span>
<span class="linenos">209</span>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gt_bboxes_3d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounding_boxes</span>
<span class="linenos">210</span>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gt_labels_3d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gt_boxes&quot;</span><span class="p">][</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span>
<span class="linenos">211</span>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;num_gt_objects_3d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_bboxes</span>
<span class="linenos">212</span>
<span class="linenos">213</span>            <span class="c1"># ----- Process 2D image ground truth data -----</span>
<span class="hll"><span class="linenos">214</span>            <span class="c1"># @NOTE Combine per‑camera 2D GT and record per‑camera counts before padding to a common size.</span>
</span><span class="linenos">215</span>            <span class="n">bboxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="s2">&quot;gt_boxes_2d&quot;</span><span class="p">][</span><span class="s2">&quot;bboxes&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cams</span><span class="p">)]</span>
<span class="linenos">216</span>            <span class="n">gt_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="s2">&quot;gt_boxes_2d&quot;</span><span class="p">][</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cams</span><span class="p">)]</span>
<span class="linenos">217</span>            <span class="n">depths</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="s2">&quot;gt_boxes_2d&quot;</span><span class="p">][</span><span class="s2">&quot;depths&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cams</span><span class="p">)]</span>
<span class="linenos">218</span>            <span class="n">centers2d</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="s2">&quot;gt_boxes_2d&quot;</span><span class="p">][</span><span class="s2">&quot;centers&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cams</span><span class="p">)]</span>
<span class="linenos">219</span>            <span class="n">num_objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">depths</span><span class="p">]</span>
<span class="linenos">220</span>
<span class="linenos">221</span>            <span class="c1"># Pad the data to a common size</span>
<span class="hll"><span class="linenos">222</span>            <span class="c1"># @NOTE</span>
</span><span class="hll"><span class="linenos">223</span>            <span class="c1"># Here, we use the `pad_to_common_size` function from the `python_operator_functions` module.</span>
</span><span class="hll"><span class="linenos">224</span>            <span class="c1"># Please refer to the additional API reference for more details.</span>
</span><span class="linenos">225</span>            <span class="n">pad_function</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">python_operator_functions</span><span class="o">.</span><span class="n">pad_to_common_size</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="linenos">226</span>            <span class="n">bboxes</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">python_function</span><span class="p">(</span><span class="o">*</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">pad_function</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="n">num_cams</span><span class="p">)</span>
<span class="linenos">227</span>            <span class="n">gt_labels</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">python_function</span><span class="p">(</span><span class="o">*</span><span class="n">gt_labels</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">pad_function</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="n">num_cams</span><span class="p">)</span>
<span class="linenos">228</span>            <span class="n">depths</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">python_function</span><span class="p">(</span><span class="o">*</span><span class="n">depths</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">pad_function</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="n">num_cams</span><span class="p">)</span>
<span class="linenos">229</span>            <span class="n">centers2d</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">python_function</span><span class="p">(</span><span class="o">*</span><span class="n">centers2d</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">pad_function</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="n">num_cams</span><span class="p">)</span>
<span class="linenos">230</span>
<span class="linenos">231</span>            <span class="c1"># Combine padded data into single tensors &amp; add the number of objects per cameras</span>
<span class="linenos">232</span>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gt_bboxes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="o">*</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">233</span>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gt_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="o">*</span><span class="n">gt_labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">234</span>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;depths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="o">*</span><span class="n">depths</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">235</span>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;centers2d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="o">*</span><span class="n">centers2d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">236</span>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;num_gt_objects&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="o">*</span><span class="n">num_objects</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">237</span>
</pre></div>
</div>
</div>
</section>
<section id="convert-existence-flag-to-float">
<h3>Convert Existence Flag to Float<a class="headerlink" href="#convert-existence-flag-to-float" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">prev_exists</span></code> flag is converted from boolean to <code class="docutils literal notranslate"><span class="pre">float</span></code> inside the pipeline. This is done as the flag
is expected to be a <code class="docutils literal notranslate"><span class="pre">float</span></code> in the training implementation.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">packages/dali_pipeline_framework/examples/pipeline_setup/additional_impl/processing_steps/stream_petr_data_combiner.py</span><a class="headerlink" href="#id6" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">238</span>        <span class="c1"># ===== Convert `prev_exists` to float =====</span>
<span class="hll"><span class="linenos">239</span>        <span class="c1"># @NOTE</span>
</span><span class="hll"><span class="linenos">240</span>        <span class="c1"># Here, we convert the `prev_exists` data field to `float`. This is needed because the training</span>
</span><span class="hll"><span class="linenos">241</span>        <span class="c1"># expects a float data type for this field. Note that the type of the data field needs to be changed</span>
</span><span class="hll"><span class="linenos">242</span>        <span class="c1"># explicitly using `change_type_of_data_and_remove_data`, before the converted data can be set.</span>
</span><span class="linenos">243</span>        <span class="n">prev_exists</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;prev_exists&quot;</span><span class="p">]</span>
<span class="linenos">244</span>        <span class="n">prev_exists_fl</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">prev_exists</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">DALIDataType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">)</span>
<span class="linenos">245</span>        <span class="n">data</span><span class="o">.</span><span class="n">change_type_of_data_and_remove_data</span><span class="p">(</span><span class="s2">&quot;prev_exists&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DALIDataType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">)</span>
<span class="linenos">246</span>        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;prev_exists&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_exists_fl</span>
<span class="linenos">247</span>
</pre></div>
</div>
</div>
</section>
<section id="cleanup">
<h3>Cleanup<a class="headerlink" href="#cleanup" title="Link to this heading"></a></h3>
<p>Unneeded fields are removed to leave only combined outputs.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">packages/dali_pipeline_framework/examples/pipeline_setup/additional_impl/processing_steps/stream_petr_data_combiner.py</span><a class="headerlink" href="#id7" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">248</span>        <span class="c1"># ===== Cleanup =====</span>
<span class="hll"><span class="linenos">249</span>        <span class="c1"># @NOTE Remove fields that are no longer needed once combined tensors have been produced.</span>
</span><span class="linenos">250</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_unneeded_fields</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">251</span>
</pre></div>
</div>
</div>
</section>
<section id="data-structure-checks-and-output-adjustments">
<h3>Data Structure Checks and &amp; Output Adjustments<a class="headerlink" href="#data-structure-checks-and-output-adjustments" title="Link to this heading"></a></h3>
<p>Helper methods validate the input data structure and add/remove fields to match the output structure.
For more details on how to implement custom processing steps, see
<a class="reference internal" href="../flexible_step/index.html"><span class="doc">Flexible Step Implementation</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">packages/dali_pipeline_framework/examples/pipeline_setup/additional_impl/processing_steps/stream_petr_data_combiner.py</span><a class="headerlink" href="#id8" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">261</span>    <span class="c1"># ===== Data structure checks and &amp; output adjustments =====</span>
<span class="hll"><span class="linenos">262</span>    <span class="c1"># @NOTE These helpers validate the input schema and add/remove fields for the output schema. See also</span>
</span><span class="hll"><span class="linenos">263</span>    <span class="c1"># the 2D object detection pipeline for a broader discussion of output blueprints.</span>
</span><span class="linenos">264</span>
<span class="linenos">265</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_adjust_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_inout</span><span class="p">:</span> <span class="n">SampleDataGroup</span><span class="p">):</span>
<span class="linenos">266</span>        <span class="c1"># Add new data fields and delete old fields.</span>
<span class="linenos">267</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_new_fields</span><span class="p">(</span><span class="n">data_inout</span><span class="p">)</span>
<span class="linenos">268</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_unneeded_fields</span><span class="p">(</span><span class="n">data_inout</span><span class="p">)</span>
<span class="linenos">269</span>
<span class="linenos">270</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_add_new_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_inout</span><span class="p">:</span> <span class="n">SampleDataGroup</span><span class="p">):</span>
<span class="linenos">271</span>        <span class="n">num_cams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_inout</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">])</span>
<span class="linenos">272</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_ground_truth_included</span><span class="p">:</span>
<span class="linenos">273</span>            <span class="n">fields_to_add_float</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">274</span>                <span class="s2">&quot;img&quot;</span><span class="p">,</span>
<span class="linenos">275</span>                <span class="s2">&quot;lidar2img&quot;</span><span class="p">,</span>
<span class="linenos">276</span>                <span class="s2">&quot;intrinsics&quot;</span><span class="p">,</span>
<span class="linenos">277</span>                <span class="s2">&quot;extrinsics&quot;</span><span class="p">,</span>
<span class="linenos">278</span>                <span class="s2">&quot;ego_pose&quot;</span><span class="p">,</span>
<span class="linenos">279</span>                <span class="s2">&quot;ego_pose_inv&quot;</span><span class="p">,</span>
<span class="linenos">280</span>                <span class="s2">&quot;gt_bboxes_3d&quot;</span><span class="p">,</span>
<span class="linenos">281</span>                <span class="s2">&quot;gt_bboxes&quot;</span><span class="p">,</span>
<span class="linenos">282</span>                <span class="s2">&quot;depths&quot;</span><span class="p">,</span>
<span class="linenos">283</span>                <span class="s2">&quot;centers2d&quot;</span><span class="p">,</span>
<span class="linenos">284</span>            <span class="p">]</span>
<span class="linenos">285</span>            <span class="n">fields_to_add_double</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;img_timestamp&quot;</span><span class="p">]</span>
<span class="linenos">286</span>            <span class="n">fields_to_add_long</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gt_labels_3d&quot;</span><span class="p">,</span> <span class="s2">&quot;num_gt_objects_3d&quot;</span><span class="p">,</span> <span class="s2">&quot;gt_labels&quot;</span><span class="p">,</span> <span class="s2">&quot;num_gt_objects&quot;</span><span class="p">]</span>
<span class="linenos">287</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">288</span>            <span class="n">fields_to_add_float</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">,</span> <span class="s2">&quot;lidar2img&quot;</span><span class="p">,</span> <span class="s2">&quot;intrinsics&quot;</span><span class="p">,</span> <span class="s2">&quot;extrinsics&quot;</span><span class="p">,</span> <span class="s2">&quot;ego_pose&quot;</span><span class="p">,</span> <span class="s2">&quot;ego_pose_inv&quot;</span><span class="p">]</span>
<span class="linenos">289</span>            <span class="n">fields_to_add_double</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;img_timestamp&quot;</span><span class="p">]</span>
<span class="linenos">290</span>            <span class="n">fields_to_add_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">291</span>
<span class="linenos">292</span>        <span class="k">for</span> <span class="n">fnm</span> <span class="ow">in</span> <span class="n">fields_to_add_float</span><span class="p">:</span>
<span class="linenos">293</span>            <span class="n">data_inout</span><span class="o">.</span><span class="n">add_data_field</span><span class="p">(</span><span class="n">fnm</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DALIDataType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">)</span>
<span class="linenos">294</span>        <span class="k">for</span> <span class="n">fnm</span> <span class="ow">in</span> <span class="n">fields_to_add_double</span><span class="p">:</span>
<span class="linenos">295</span>            <span class="n">data_inout</span><span class="o">.</span><span class="n">add_data_field</span><span class="p">(</span><span class="n">fnm</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DALIDataType</span><span class="o">.</span><span class="n">FLOAT64</span><span class="p">)</span>
<span class="linenos">296</span>        <span class="k">for</span> <span class="n">fnm</span> <span class="ow">in</span> <span class="n">fields_to_add_long</span><span class="p">:</span>
<span class="linenos">297</span>            <span class="n">data_inout</span><span class="o">.</span><span class="n">add_data_field</span><span class="p">(</span><span class="n">fnm</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DALIDataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">)</span>
<span class="linenos">298</span>
<span class="linenos">299</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_unneeded_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_inout</span><span class="p">:</span> <span class="n">SampleDataGroup</span><span class="p">):</span>
<span class="linenos">300</span>        <span class="n">data_inout</span><span class="o">.</span><span class="n">remove_field</span><span class="p">(</span><span class="s2">&quot;cams&quot;</span><span class="p">)</span>
<span class="linenos">301</span>        <span class="n">data_inout</span><span class="o">.</span><span class="n">remove_field</span><span class="p">(</span><span class="s2">&quot;gt_boxes&quot;</span><span class="p">)</span>
<span class="linenos">302</span>        <span class="n">data_inout</span><span class="o">.</span><span class="n">remove_field</span><span class="p">(</span><span class="s2">&quot;ego_pose_geom&quot;</span><span class="p">)</span>
<span class="linenos">303</span>
<span class="linenos">304</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_input_data_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">SampleDataGroup</span><span class="p">):</span>
<span class="linenos">305</span>        <span class="c1"># Top-level fields</span>
<span class="linenos">306</span>        <span class="n">data</span><span class="o">.</span><span class="n">check_has_children</span><span class="p">(</span>
<span class="linenos">307</span>            <span class="n">data_field_children</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;prev_exists&quot;</span><span class="p">],</span>
<span class="linenos">308</span>            <span class="n">data_group_field_children</span><span class="o">=</span><span class="p">(</span>
<span class="linenos">309</span>                <span class="p">[</span><span class="s2">&quot;ego_pose_geom&quot;</span><span class="p">,</span> <span class="s2">&quot;gt_boxes&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_ground_truth_included</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;ego_pose_geom&quot;</span><span class="p">]</span>
<span class="linenos">310</span>            <span class="p">),</span>
<span class="linenos">311</span>            <span class="n">data_group_field_array_children</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">],</span>
<span class="linenos">312</span>            <span class="n">current_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">313</span>        <span class="p">)</span>
<span class="linenos">314</span>
<span class="linenos">315</span>        <span class="c1"># Ego-pose</span>
<span class="linenos">316</span>        <span class="n">data_ego_pose</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ego_pose_geom&quot;</span><span class="p">]</span>
<span class="linenos">317</span>        <span class="n">data_ego_pose</span><span class="o">.</span><span class="n">check_has_children</span><span class="p">(</span>
<span class="linenos">318</span>            <span class="n">data_field_children</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lidar_ego_pose&quot;</span><span class="p">,</span> <span class="s2">&quot;lidar_ego_pose_inv&quot;</span><span class="p">],</span> <span class="n">current_name</span><span class="o">=</span><span class="s2">&quot;[&#39;ego_pose_geom&#39;]&quot;</span>
<span class="linenos">319</span>        <span class="p">)</span>
<span class="linenos">320</span>
<span class="linenos">321</span>        <span class="c1"># Cameras</span>
<span class="linenos">322</span>        <span class="n">num_cams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">])</span>
<span class="linenos">323</span>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cams</span><span class="p">):</span>
<span class="linenos">324</span>
<span class="linenos">325</span>            <span class="n">cam_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cams&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
<span class="linenos">326</span>            <span class="n">cam_data</span><span class="o">.</span><span class="n">check_has_children</span><span class="p">(</span>
<span class="linenos">327</span>                <span class="n">data_field_children</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
<span class="linenos">328</span>                <span class="n">data_group_field_children</span><span class="o">=</span><span class="p">(</span>
<span class="linenos">329</span>                    <span class="p">[</span><span class="s2">&quot;cam_geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;gt_boxes_2d&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_ground_truth_included</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;cam_geometry&quot;</span><span class="p">]</span>
<span class="linenos">330</span>                <span class="p">),</span>
<span class="linenos">331</span>                <span class="n">current_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[&#39;cams&#39;][</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
<span class="linenos">332</span>            <span class="p">)</span>
<span class="linenos">333</span>            <span class="n">cam_geom_data</span> <span class="o">=</span> <span class="n">cam_data</span><span class="p">[</span><span class="s2">&quot;cam_geometry&quot;</span><span class="p">]</span>
<span class="linenos">334</span>            <span class="n">cam_geom_data</span><span class="o">.</span><span class="n">check_has_children</span><span class="p">(</span>
<span class="linenos">335</span>                <span class="n">data_field_children</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;extr_lidar2img&quot;</span><span class="p">,</span> <span class="s2">&quot;intr_lidar2img&quot;</span><span class="p">,</span> <span class="s2">&quot;lidar2img&quot;</span><span class="p">],</span>
<span class="linenos">336</span>                <span class="n">current_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[&#39;cams&#39;][</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">][&#39;cam_geometry&#39;]&quot;</span><span class="p">,</span>
<span class="linenos">337</span>            <span class="p">)</span>
<span class="linenos">338</span>
<span class="linenos">339</span>            <span class="c1"># If needed, also check image ground truth</span>
<span class="linenos">340</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_ground_truth_included</span><span class="p">:</span>
<span class="linenos">341</span>                <span class="n">img_gt_data</span> <span class="o">=</span> <span class="n">cam_data</span><span class="p">[</span><span class="s2">&quot;gt_boxes_2d&quot;</span><span class="p">]</span>
<span class="linenos">342</span>                <span class="n">img_gt_data</span><span class="o">.</span><span class="n">check_has_children</span><span class="p">(</span>
<span class="linenos">343</span>                    <span class="n">data_field_children</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;bboxes&quot;</span><span class="p">,</span> <span class="s2">&quot;centers&quot;</span><span class="p">,</span> <span class="s2">&quot;depths&quot;</span><span class="p">,</span> <span class="s2">&quot;categories&quot;</span><span class="p">],</span>
<span class="linenos">344</span>                    <span class="n">current_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[&#39;cams&#39;][</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">][&#39;gt_boxes_2d&#39;]&quot;</span><span class="p">,</span>
<span class="linenos">345</span>                <span class="p">)</span>
<span class="linenos">346</span>
<span class="linenos">347</span>        <span class="c1"># If needed, also check 3D ground truth</span>
<span class="linenos">348</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_ground_truth_included</span><span class="p">:</span>
<span class="linenos">349</span>            <span class="n">gt_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gt_boxes&quot;</span><span class="p">]</span>
<span class="linenos">350</span>            <span class="n">gt_data</span><span class="o">.</span><span class="n">check_has_children</span><span class="p">(</span>
<span class="linenos">351</span>                <span class="n">data_field_children</span><span class="o">=</span><span class="p">[</span>
<span class="linenos">352</span>                    <span class="s2">&quot;categories&quot;</span><span class="p">,</span>
<span class="linenos">353</span>                    <span class="s2">&quot;sizes&quot;</span><span class="p">,</span>
<span class="linenos">354</span>                    <span class="s2">&quot;rotations&quot;</span><span class="p">,</span>
<span class="linenos">355</span>                    <span class="s2">&quot;translations&quot;</span><span class="p">,</span>
<span class="linenos">356</span>                    <span class="s2">&quot;visibility_level&quot;</span><span class="p">,</span>
<span class="linenos">357</span>                    <span class="s2">&quot;orientations&quot;</span><span class="p">,</span>
<span class="linenos">358</span>                    <span class="s2">&quot;velocities&quot;</span><span class="p">,</span>
<span class="linenos">359</span>                <span class="p">],</span>
<span class="linenos">360</span>                <span class="n">current_name</span><span class="o">=</span><span class="s2">&quot;&#39;[gt_boxes]&#39;&quot;</span><span class="p">,</span>
<span class="linenos">361</span>            <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="pipeline_setup.html" class="btn btn-neutral float-left" title="StreamPETR Pipeline Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="custom_post_processing.html" class="btn btn-neutral float-right" title="Custom Post-Processing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, NVIDIA Corporation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>