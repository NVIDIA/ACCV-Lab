

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction &mdash; ACCV-Lab 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=9282052d" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="API Reference" href="api.html" />
    <link rel="prev" title="Draw Heatmap" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ACCV-Lab
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../project_overview/README.html">ACCV-Lab Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides_index.html">Guides</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contained Packages</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../on_demand_video_decoder/docs/index.html">On Demand Video Decoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../batching_helpers/docs/index.html">Batching Helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dali_pipeline_framework/docs/index.html">DALI Pipeline Framework</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Draw Heatmap</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#benchmark">Benchmark</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#python-wrapper">Python Wrapper</a></li>
<li class="toctree-l4"><a class="reference internal" href="#c-benchmark-implementation">C++ Benchmark Implementation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#installation">Installation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../optim_test_tools/docs/index.html">Optimization Testing Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ACCV-Lab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Draw Heatmap</a></li>
      <li class="breadcrumb-item active">Introduction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/contained_package_docs_mirror/draw_heatmap/docs/intro.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>In the realm of object detection model training, there is usually a centerness loss term, which measures how
close the center of predicted bounding box is to that of the ground truth one.
<a class="reference external" href="https://ieeexplore.ieee.org/abstract/document/9776580">GaussianFocalLoss</a> is employed to calculate this
centerness loss term, as the following formula shows:</p>
<div class="math notranslate nohighlight">
\[\begin{split}loss(pred, target) = - \left( 1 - p_t \right)^\alpha \cdot log(p_t) \cdot g_t,
where
\left\{
\begin{aligned}
p_t &amp; = pred, \ g_t = 1, \ when \ target = 1 \\
p_t &amp; = 1 - pred, \ g_t = (1 - target)^\gamma, \ when \ target \ != 1
\end{aligned}
\right.\end{split}\]</div>
<p>Both <cite>pred</cite> and <cite>target</cite> tensors are of shape <code class="docutils literal notranslate"><span class="pre">(num_heatmaps,</span> <span class="pre">height,</span> <span class="pre">width)</span></code> and their values are within
the range <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">1)</span></code> (open interval for <cite>pred</cite>, and closed interval for <cite>target</cite>). The <cite>target</cite> tensor is
actually a Gaussian heatmap which is drawn based on ground truth bounding boxes using a Gaussian 2d kernel.</p>
<img alt="bboxes to heatmap" class="align-center" src="../../../_images/bboxes_to_heatmap.png" />
<p>The existing implementation of drawing Gaussian heatmap (e.g.,
<a class="reference external" href="https://mmdetection.readthedocs.io/en/v2.9.0/_modules/mmdet/models/utils/gaussian_target.html">mmdet.models.utils.gaussian_target</a>)
involves CPU operation and handles each bounding box in each heatmap sequentially, which is inefficient and of
low GPU utilization. In this repo, we implement a GPU kernel for drawing Gaussian heatmaps and port it as a
PyTorch GPU operator, which calculates the <cite>target</cite> tensor based on centers and radii of bounding boxes. The
GPU kernel can batchify the operation and achieve significant speedup compared to the existing implementation.</p>
</section>
<section id="benchmark">
<h2>Benchmark<a class="headerlink" href="#benchmark" title="Link to this heading"></a></h2>
<section id="python-wrapper">
<h3>Python Wrapper<a class="headerlink" href="#python-wrapper" title="Link to this heading"></a></h3>
<p>This package provides convenient Python wrappers for our GPU kernel. In this section, we benchmark the
performance of the python wrapper and PyTorch implementation.
Generally, this package provides <strong>two implementations</strong> for drawing the heatmaps:</p>
<ul class="simple">
<li><p><a class="reference internal" href="api.html#accvlab.draw_heatmap.draw_heatmap" title="accvlab.draw_heatmap.draw_heatmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">draw_heatmap()</span></code></a>: this implementation is designed for the <strong>concatenated</strong> input
format.</p></li>
<li><p><a class="reference internal" href="api.html#accvlab.draw_heatmap.draw_heatmap_batched" title="accvlab.draw_heatmap.draw_heatmap_batched"><code class="xref py py-func docutils literal notranslate"><span class="pre">draw_heatmap_batched()</span></code></a>: this implementation is designed for the <strong>batched</strong>
input format.</p></li>
</ul>
<p>The benchmark results are shown in the following table.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The shape of heatmap is <code class="docutils literal notranslate"><span class="pre">(batch_size,</span> <span class="pre">height,</span> <span class="pre">width)</span></code>, and the performance is measured on a single
NVIDIA A100 GPU.</p>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Implementation</p></th>
<th class="head"><p>Heatmap shape</p></th>
<th class="head"><p>Performance</p></th>
<th class="head"><p>Speedup</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PyTorch</p></td>
<td><p>48x20x50</p></td>
<td><p>201.1 ms</p></td>
<td><p>—</p></td>
</tr>
<tr class="row-odd"><td><p>draw_heatmap (concat)</p></td>
<td><p>48x20x50</p></td>
<td><p>0.0482 ms</p></td>
<td><p>4189.42x</p></td>
</tr>
<tr class="row-even"><td><p>draw_heatmap_batched</p></td>
<td><p>48x20x50</p></td>
<td><p>0.0366 ms</p></td>
<td><p>5494.32x</p></td>
</tr>
</tbody>
</table>
<p>Other than that, this package also provides a classwise implementation for drawing the heatmaps, which is to
draw one heatmap image for each class. This is only directly supported by
<a class="reference internal" href="api.html#accvlab.draw_heatmap.draw_heatmap_batched" title="accvlab.draw_heatmap.draw_heatmap_batched"><code class="xref py py-func docutils literal notranslate"><span class="pre">draw_heatmap_batched()</span></code></a>.</p>
<p>The benchmark results for this implementation are shown in the following table.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The shape of heatmap is <code class="docutils literal notranslate"><span class="pre">(batch_size,</span> <span class="pre">num_classes,</span> <span class="pre">height,</span> <span class="pre">width)</span></code>, and the performance is measured on a
single NVIDIA A100 GPU.</p>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Implementation</p></th>
<th class="head"><p>Heatmap shape</p></th>
<th class="head"><p>Performance</p></th>
<th class="head"><p>Speedup</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PyTorch</p></td>
<td><p>48x20x20x50</p></td>
<td><p>245.1 ms</p></td>
<td><p>—</p></td>
</tr>
<tr class="row-odd"><td><p>draw_heatmap_batched</p></td>
<td><p>48x20x20x50</p></td>
<td><p>0.059 ms</p></td>
<td><p>4154.24x</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While the classwise implementation is only directly supported by
<a class="reference internal" href="api.html#accvlab.draw_heatmap.draw_heatmap_batched" title="accvlab.draw_heatmap.draw_heatmap_batched"><code class="xref py py-func docutils literal notranslate"><span class="pre">draw_heatmap_batched()</span></code></a>, it can
be also achieved in <a class="reference internal" href="api.html#accvlab.draw_heatmap.draw_heatmap" title="accvlab.draw_heatmap.draw_heatmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">draw_heatmap()</span></code></a>, as here, the indices of images to draw into
are set manually for each bounding box, so that the indices could be set up to map to both different samples
and different classes within a sample.</p>
</div>
</section>
<section id="c-benchmark-implementation">
<h3>C++ Benchmark Implementation<a class="headerlink" href="#c-benchmark-implementation" title="Link to this heading"></a></h3>
<p>There is also a C++ benchmark for directly measuring the performance of the C++ implementation without
the PyTorch wrapper. It can be built by running the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>packages/draw_heatmap/benchmark_cpp
mkdir<span class="w"> </span>build
<span class="nb">cd</span><span class="w"> </span>build
cmake<span class="w"> </span>..
make
</pre></div>
</div>
<p>Then, the performance measurements can be obtained by running the following commands.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./benchmark_flattened
./benchmark_batched
./benchmark_batched_classwise
</pre></div>
</div>
</section>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Link to this heading"></a></h2>
<p>This package is installed as part of the <cite>accvlab</cite> package. Please refer to the
<a class="reference internal" href="../../../guides/INSTALLATION_GUIDE.html"><span class="doc">Installation Guide</span></a> for more details.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This package has a runtime dependency on the
<a class="reference internal" href="../../batching_helpers/docs/introduction.html"><span class="doc">accvlab.batching_helpers</span></a> package. Please install it
before installing this package.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Draw Heatmap" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="api.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, NVIDIA Corporation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>