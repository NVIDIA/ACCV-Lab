

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DataLoader Separation Decode Example &mdash; ACCV-Lab 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css?v=9282052d" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="DataLoader Demuxer-Free Example" href="dataloader_demuxer_free_decode.html" />
    <link rel="prev" title="DataLoader Stream Decode Example" href="dataloader_stream_decode.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            ACCV-Lab
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../project_overview/README.html">ACCV-Lab Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guides_index.html">Guides</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contained Packages</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">On Demand Video Decoder</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dataset_preparation.html">Dataset Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sample.html">Sample Code Documentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">PyTorch Integration Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="dataloader_random_decode.html">DataLoader Random Decode Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="dataloader_stream_decode.html">DataLoader Stream Decode Example</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">DataLoader Separation Decode Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#key-features">Key Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#index-data-format">Index Data Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-loading-structure">Data Loading Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#basic-usage">Basic Usage</a></li>
<li class="toctree-l5"><a class="reference internal" href="#distributed-training">Distributed Training</a></li>
<li class="toctree-l5"><a class="reference internal" href="#command-line-arguments">Command Line Arguments</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#architecture">Architecture</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#videoclipdatasetwithpynvvideo">VideoClipDatasetWithPyNVVideo</a></li>
<li class="toctree-l5"><a class="reference internal" href="#videoclipsampler">VideoClipSampler</a></li>
<li class="toctree-l5"><a class="reference internal" href="#example-training-loop">Example Training Loop</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#performance">Performance</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#test-environment">Test Environment</a></li>
<li class="toctree-l5"><a class="reference internal" href="#performance-metrics-frames-sec">Performance Metrics (frames/sec)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#performance-optimization-tips">Performance Optimization Tips</a></li>
<li class="toctree-l5"><a class="reference internal" href="#performance-profiling">Performance Profiling</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="dataloader_demuxer_free_decode.html">DataLoader Demuxer-Free Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../evaluation.html">Evaluation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../batching_helpers/docs/index.html">Batching Helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dali_pipeline_framework/docs/index.html">DALI Pipeline Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../draw_heatmap/docs/index.html">Draw Heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim_test_tools/docs/index.html">Optimization Testing Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ACCV-Lab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">On Demand Video Decoder</a></li>
          <li class="breadcrumb-item"><a href="index.html">PyTorch Integration Examples</a></li>
      <li class="breadcrumb-item active">DataLoader Separation Decode Example</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/contained_package_docs_mirror/on_demand_video_decoder/docs/pytorch_integration_examples/dataloader_separation_decode.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dataloader-separation-decode-example">
<h1>DataLoader Separation Decode Example<a class="headerlink" href="#dataloader-separation-decode-example" title="Link to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>This example demonstrates how to use NVIDIA’s accvlab.on_demand_video_decoder library with PyTorch DataLoader for efficient separation-based video decoding, ideal for training scenarios that require random access to video frames (e.g., random sampling for data augmentation).</p>
<p>The specific code implementation can be found in <code class="docutils literal notranslate"><span class="pre">packages/on_demand_video_decoder/examples/dataloader_separation_decode</span></code>.</p>
<p>The “separation” approach refers to decoupling the video demuxing (CPU) and decoding (GPU) processes, which enables:</p>
<ul class="simple">
<li><p><strong>Process Isolation</strong>: Demuxing runs in DataLoader workers (CPU-only), while decoding runs in the main process (GPU)</p></li>
<li><p><strong>Memory Efficiency</strong>: Avoids GPU memory duplication across multiple workers</p></li>
<li><p><strong>Flexible Sampling</strong>: Supports random frame access patterns efficiently</p></li>
</ul>
<img alt="SeparationAccess Optimization Overview" src="../../../../_images/separation_access.png" />
</section>
<section id="key-features">
<h2>Key Features<a class="headerlink" href="#key-features" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Custom PyTorch Dataset</strong>: Implements lazy initialization of the GPU decoder to optimize memory usage</p></li>
<li><p><strong>Custom Sampler</strong>: Organizes video clips into batches for efficient processing with distributed training support</p></li>
<li><p><strong>Multi-camera Support</strong>: Handles synchronized frames from multiple cameras with random or stream access</p></li>
<li><p><strong>Distributed Training</strong>: Compatible with PyTorch’s distributed training framework</p></li>
<li><p><strong>Performance Profiling</strong>: Includes NVTX markers for performance analysis</p></li>
<li><p><strong>Error Handling</strong>: Comprehensive error handling and validation</p></li>
<li><p><strong>Separation Decoding</strong>: CPU demuxing in workers, GPU decoding in main process</p></li>
</ul>
</section>
<section id="index-data-format">
<h2>Index Data Format<a class="headerlink" href="#index-data-format" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The JSON file and the selection of frames to access are used here for demonstration purposes. In a
real-world scenario, the file names and indices would be obtained from the dataset metadata.</p>
</div>
<p>The example expects a JSON file with the following structure:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{
    &quot;video_dir1&quot;: {
        &quot;clip0id&quot;: frame_count,
        &quot;clip1id&quot;: frame_count,
        ...
    },
    &quot;video_dir2&quot;: {
        &quot;clip0id&quot;: frame_count,
        &quot;clip1id&quot;: frame_count,
        ...
    }
}
</pre></div>
</div>
<p>Each video directory should contain subdirectories for each clip, and each clip directory should contain MP4 files for different cameras.</p>
</section>
<section id="data-loading-structure">
<h2>Data Loading Structure<a class="headerlink" href="#data-loading-structure" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>For Random Access Pattern, ref to <code class="docutils literal notranslate"><span class="pre">packages/on_demand_video_decoder/docs/example/dataloader_random_decode.md</span></code>.</p></li>
<li><p>For Stream Access Pattern, ref to <code class="docutils literal notranslate"><span class="pre">packages/on_demand_video_decoder/docs/example/dataloader_stream_decode.md</span></code>.</p></li>
</ul>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Link to this heading"></a></h2>
<section id="basic-usage">
<h3>Basic Usage<a class="headerlink" href="#basic-usage" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>main.py<span class="w"> </span>--index_file<span class="w"> </span>/path/to/index_frame.json<span class="w"> </span>--group_num<span class="w"> </span><span class="m">4</span><span class="w"> </span>--num_workers<span class="w"> </span><span class="m">2</span>
</pre></div>
</div>
</section>
<section id="distributed-training">
<h3>Distributed Training<a class="headerlink" href="#distributed-training" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>torch.distributed.run<span class="w"> </span>--nproc_per_node<span class="o">=</span><span class="m">2</span><span class="w"> </span>main.py<span class="w"> </span>--index_file<span class="w"> </span>/path/to/index_frame.json<span class="w"> </span>--group_num<span class="w"> </span><span class="m">4</span><span class="w"> </span>--num_workers<span class="w"> </span><span class="m">2</span>
</pre></div>
</div>
</section>
<section id="command-line-arguments">
<h3>Command Line Arguments<a class="headerlink" href="#command-line-arguments" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--index_file</span></code>: Path to the JSON file containing frame index information (default: <code class="docutils literal notranslate"><span class="pre">example/index_frame.json</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--group_num</span></code>: Number of clips to process in each batch (default: 4)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--num_workers</span></code>: Number of worker processes for data loading (default: 2)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--disable_cache</span></code>: If cache gop in main processor.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--frame_read_type</span></code>: Choose <code class="docutils literal notranslate"><span class="pre">stream</span></code> or <code class="docutils literal notranslate"><span class="pre">random</span></code> access pattern.</p></li>
</ul>
</section>
</section>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Link to this heading"></a></h2>
<section id="videoclipdatasetwithpynvvideo">
<h3>VideoClipDatasetWithPyNVVideo<a class="headerlink" href="#videoclipdatasetwithpynvvideo" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">VideoClipDatasetWithPyNVVideo</span></code> class extends PyTorch’s <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> and provides:</p>
<ul class="simple">
<li><p>Lazy initialization of the NVIDIA separation decoder</p></li>
<li><p>GPU-accelerated random frame decoding</p></li>
<li><p>Multi-camera frame synchronization with random access</p></li>
<li><p>Error handling and validation</p></li>
<li><p><strong>Separation Decoder Configuration</strong> (<code class="docutils literal notranslate"><span class="pre">accvlab.on_demand_video_decoder</span></code>):</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">demux_mode</span></code>: Separation mode decouples demuxing (CPU workers) from decoding (GPU main process)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">device</span></code>: GPU device ID for decoding</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">packet_cache</span></code>: Caches GOP packets in main process to avoid IPC overhead</p></li>
</ul>
</li>
</ul>
<p><strong>Implementation:</strong></p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">examples/dataloader_separation_decode/main.py</span><a class="headerlink" href="#id1" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">131</span><span class="c1"># .. doc-marker-begin: dataset-separation</span>
<span class="linenos">132</span><span class="k">class</span><span class="w"> </span><span class="nc">VideoClipDatasetWithPyNVVideo</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<span class="linenos">133</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">134</span><span class="sd">    Custom PyTorch Dataset for video clip processing with accvlab.on_demand_video_decoder.</span>
<span class="linenos">135</span>
<span class="linenos">136</span><span class="sd">    This dataset provides lazy initialization of the GPU decoder and efficient</span>
<span class="linenos">137</span><span class="sd">    video frame extraction for multi-camera datasets.</span>
<span class="linenos">138</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">139</span>
<span class="linenos">140</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<span class="linenos">141</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">index_frame</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">group_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_cameras</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">NUM_CAMERAS</span>
<span class="linenos">142</span>    <span class="p">):</span>
<span class="linenos">143</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">144</span><span class="sd">        Initialize the VideoClipDatasetWithPyNVVideo.</span>
<span class="linenos">145</span>
<span class="linenos">146</span><span class="sd">        Args:</span>
<span class="linenos">147</span><span class="sd">            index_frame: Dictionary mapping video directories to clip frame counts.</span>
<span class="linenos">148</span><span class="sd">            group_num: Number of clips to process in each group.</span>
<span class="linenos">149</span><span class="sd">            num_cameras: Number of cameras in the dataset.</span>
<span class="linenos">150</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">151</span>        <span class="bp">self</span><span class="o">.</span><span class="n">index_frame</span> <span class="o">=</span> <span class="n">index_frame</span>
<span class="linenos">152</span>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cameras</span> <span class="o">=</span> <span class="n">num_cameras</span>
<span class="linenos">153</span>        <span class="bp">self</span><span class="o">.</span><span class="n">group_num</span> <span class="o">=</span> <span class="n">group_num</span>
<span class="linenos">154</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_is_initialized</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">155</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_indexing_demuxer</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">156</span>
<span class="linenos">157</span>        <span class="c1"># Validate inputs</span>
<span class="linenos">158</span>        <span class="k">if</span> <span class="n">group_num</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">159</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;group_num must be positive, got </span><span class="si">{</span><span class="n">group_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">160</span>        <span class="k">if</span> <span class="n">num_cameras</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">161</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;num_cameras must be positive, got </span><span class="si">{</span><span class="n">num_cameras</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">162</span>
<span class="linenos">163</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized dataset with </span><span class="si">{</span><span class="n">num_cameras</span><span class="si">}</span><span class="s2"> cameras, group_num=</span><span class="si">{</span><span class="n">group_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">164</span>
<span class="linenos">165</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="linenos">166</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">167</span><span class="sd">        Get the total number of samples in the dataset.</span>
<span class="linenos">168</span>
<span class="linenos">169</span><span class="sd">        Returns:</span>
<span class="linenos">170</span><span class="sd">            Total number of samples.</span>
<span class="linenos">171</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">172</span>        <span class="n">total_frames</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">173</span>        <span class="k">for</span> <span class="n">video_dir</span><span class="p">,</span> <span class="n">clip_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_frame</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">174</span>            <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">frame_count</span> <span class="ow">in</span> <span class="n">clip_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">175</span>                <span class="n">total_frames</span> <span class="o">+=</span> <span class="n">frame_count</span>
<span class="linenos">176</span>
<span class="linenos">177</span>        <span class="n">length</span> <span class="o">=</span> <span class="n">total_frames</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_num</span>
<span class="linenos">178</span>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset length: </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2"> (total_frames=</span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2">, group_num=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">group_num</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="linenos">179</span>        <span class="k">return</span> <span class="n">length</span>
<span class="linenos">180</span>
<span class="linenos">181</span>    <span class="k">def</span><span class="w"> </span><span class="nf">__lazy_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="linenos">182</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Lazy initialize the video demuxer to optimize memory usage.&quot;&quot;&quot;</span>
<span class="linenos">183</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_initialized</span><span class="p">:</span>
<span class="linenos">184</span>            <span class="k">return</span>
<span class="linenos">185</span>
<span class="linenos">186</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">187</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_indexing_demuxer</span> <span class="o">=</span> <span class="n">video_demuxing</span><span class="o">.</span><span class="n">IndexingDemuxerOndemand</span><span class="p">(</span>
<span class="linenos">188</span>                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_num</span><span class="p">,</span>
<span class="linenos">189</span>                <span class="n">num_cameras</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cameras</span><span class="p">,</span>
<span class="linenos">190</span>                <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span>
<span class="linenos">191</span>            <span class="p">)</span>
<span class="linenos">192</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_is_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">193</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Video demuxer initialized successfully&quot;</span><span class="p">)</span>
<span class="linenos">194</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">195</span>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize video demuxer: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">196</span>            <span class="k">raise</span>
<span class="linenos">197</span>
<span class="linenos">198</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="linenos">199</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">200</span><span class="sd">        Get video frames for the given index.</span>
<span class="linenos">201</span>
<span class="linenos">202</span><span class="sd">        Args:</span>
<span class="linenos">203</span><span class="sd">            index: List of (clip_path, frame_idx) tuples.</span>
<span class="linenos">204</span>
<span class="linenos">205</span><span class="sd">        Returns:</span>
<span class="linenos">206</span><span class="sd">            List of episode buffers containing video frame data.</span>
<span class="linenos">207</span>
<span class="linenos">208</span><span class="sd">        Raises:</span>
<span class="linenos">209</span><span class="sd">            ValueError: If index format is invalid.</span>
<span class="linenos">210</span><span class="sd">            RuntimeError: If video demuxer fails to process frames.</span>
<span class="linenos">211</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">212</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<span class="linenos">213</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected list of tuples, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">214</span>
<span class="linenos">215</span>        <span class="n">use_cache</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">216</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__lazy_init__</span><span class="p">(</span><span class="n">use_cache</span><span class="p">)</span>
<span class="linenos">217</span>        <span class="n">episode_buffers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">218</span>
<span class="linenos">219</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">220</span>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">clip_path</span><span class="p">,</span> <span class="n">frame_idx</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
<span class="linenos">221</span>                <span class="c1"># Find all MP4 files in the clip directory</span>
<span class="linenos">222</span>                <span class="n">video_paths</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">223</span>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clip_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">clip_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mp4&#39;</span><span class="p">)</span>
<span class="linenos">224</span>                <span class="p">]</span>
<span class="linenos">225</span>
<span class="linenos">226</span>                <span class="k">if</span> <span class="ow">not</span> <span class="n">video_paths</span><span class="p">:</span>
<span class="linenos">227</span>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No MP4 files found in </span><span class="si">{</span><span class="n">clip_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">228</span>                    <span class="k">continue</span>
<span class="linenos">229</span>
<span class="linenos">230</span>                <span class="c1"># Create frame indices for all cameras</span>
<span class="linenos">231</span>                <span class="n">frame_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame_idx</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">video_paths</span><span class="p">)</span>
<span class="linenos">232</span>
<span class="linenos">233</span>                <span class="c1"># Update demuxer paths and get packet buffers</span>
<span class="linenos">234</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_indexing_demuxer</span><span class="o">.</span><span class="n">update_path</span><span class="p">(</span><span class="n">video_paths</span><span class="p">)</span>
<span class="linenos">235</span>                <span class="n">episode_buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="linenos">236</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">_indexing_demuxer</span><span class="o">.</span><span class="n">packet_buffers_for_frame_idx_list</span><span class="p">(</span><span class="n">frame_indices</span><span class="p">,</span> <span class="n">sample_idx</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">237</span>                <span class="p">)</span>
<span class="linenos">238</span>
<span class="linenos">239</span>            <span class="k">return</span> <span class="n">episode_buffers</span>
<span class="linenos">240</span>
<span class="linenos">241</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">242</span>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">243</span>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process video frames: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">244</span>
<span class="linenos">245</span>
</pre></div>
</div>
</div>
</section>
<section id="videoclipsampler">
<h3>VideoClipSampler<a class="headerlink" href="#videoclipsampler" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">VideoClipSampler</span></code> class extends PyTorch’s <code class="docutils literal notranslate"><span class="pre">Sampler</span></code> and provides:</p>
<ul class="simple">
<li><p>Random clip sampling for data diversity</p></li>
<li><p>Efficient batch organization with flexible sampling</p></li>
<li><p>Distributed training support with proper sharding</p></li>
<li><p>Optional shuffling support for each epoch</p></li>
</ul>
</section>
<section id="example-training-loop">
<h3>Example Training Loop<a class="headerlink" href="#example-training-loop" title="Link to this heading"></a></h3>
<p>The following code shows the complete setup for training with separation-based decoding:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">examples/dataloader_separation_decode/main.py</span><a class="headerlink" href="#id2" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">465</span>        <span class="c1"># .. doc-marker-begin: training-setup-separation</span>
<span class="linenos">466</span>        <span class="n">local_rank</span><span class="p">,</span> <span class="n">local_world_size</span> <span class="o">=</span> <span class="n">setup_distributed</span><span class="p">()</span>
<span class="linenos">467</span>
<span class="linenos">468</span>        <span class="c1"># Load index frame</span>
<span class="linenos">469</span>        <span class="n">index_frame</span> <span class="o">=</span> <span class="n">load_index_frame</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">index_file</span><span class="p">)</span>
<span class="linenos">470</span>
<span class="linenos">471</span>        <span class="c1"># Create dataset and dataloader</span>
<span class="linenos">472</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">VideoClipDatasetWithPyNVVideo</span><span class="p">(</span><span class="n">index_frame</span><span class="o">=</span><span class="n">index_frame</span><span class="p">,</span> <span class="n">group_num</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">group_num</span><span class="p">)</span>
<span class="linenos">473</span>
<span class="linenos">474</span>        <span class="c1"># Create sampler based on frame_read_type</span>
<span class="linenos">475</span>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">frame_read_type</span> <span class="o">==</span> <span class="s1">&#39;stream&#39;</span><span class="p">:</span>
<span class="linenos">476</span>            <span class="n">sampler</span> <span class="o">=</span> <span class="n">video_clip_sampler</span><span class="o">.</span><span class="n">VideoClipSamplerStream</span><span class="p">(</span>
<span class="linenos">477</span>                <span class="n">index_frame</span><span class="o">=</span><span class="n">index_frame</span><span class="p">,</span>
<span class="linenos">478</span>                <span class="n">group_num</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">group_num</span><span class="p">,</span>
<span class="linenos">479</span>                <span class="n">rank</span><span class="o">=</span><span class="n">local_rank</span><span class="p">,</span>
<span class="linenos">480</span>                <span class="n">world_size</span><span class="o">=</span><span class="n">local_world_size</span><span class="p">,</span>
<span class="linenos">481</span>                <span class="n">use_cache</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">disable_cache</span><span class="p">,</span>
<span class="linenos">482</span>            <span class="p">)</span>
<span class="linenos">483</span>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">frame_read_type</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
<span class="linenos">484</span>            <span class="n">sampler</span> <span class="o">=</span> <span class="n">video_clip_sampler</span><span class="o">.</span><span class="n">VideoClipSamplerRandom</span><span class="p">(</span>
<span class="linenos">485</span>                <span class="n">index_frame</span><span class="o">=</span><span class="n">index_frame</span><span class="p">,</span>
<span class="linenos">486</span>                <span class="n">group_num</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">group_num</span><span class="p">,</span>
<span class="linenos">487</span>                <span class="n">rank</span><span class="o">=</span><span class="n">local_rank</span><span class="p">,</span>
<span class="linenos">488</span>                <span class="n">world_size</span><span class="o">=</span><span class="n">local_world_size</span><span class="p">,</span>
<span class="linenos">489</span>            <span class="p">)</span>
<span class="linenos">490</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">491</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown frame_read_type: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">frame_read_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">492</span>
<span class="linenos">493</span>        <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
<span class="linenos">494</span>            <span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos">495</span>        <span class="p">)</span>
<span class="linenos">496</span>
<span class="linenos">497</span>        <span class="c1"># Create video decoder</span>
<span class="linenos">498</span>        <span class="n">decode_video_on_demand</span> <span class="o">=</span> <span class="n">video_transforms</span><span class="o">.</span><span class="n">DecodeVideoOnDemand</span><span class="p">(</span>
<span class="linenos">499</span>            <span class="n">device_id</span><span class="o">=</span><span class="n">local_rank</span><span class="p">,</span> <span class="n">num_cameras</span><span class="o">=</span><span class="n">NUM_CAMERAS</span>
<span class="linenos">500</span>        <span class="p">)</span>
<span class="linenos">501</span>
<span class="linenos">502</span>        <span class="c1"># Run warmup</span>
<span class="linenos">503</span>        <span class="n">run_warmup</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">decode_video_on_demand</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">warmup_iterations</span><span class="p">)</span>
<span class="linenos">504</span>
<span class="linenos">505</span>        <span class="c1"># Run benchmark</span>
<span class="linenos">506</span>        <span class="n">metrics</span> <span class="o">=</span> <span class="n">run_benchmark</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">decode_video_on_demand</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">group_num</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">log_interval</span><span class="p">)</span>
<span class="linenos">507</span>
<span class="linenos">508</span>        <span class="c1"># Print results</span>
<span class="linenos">509</span>        <span class="n">print_performance_summary</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Link to this heading"></a></h2>
<section id="test-environment">
<h3>Test Environment<a class="headerlink" href="#test-environment" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>GPU</strong>: NVIDIA A100-SXM4-80GB</p></li>
<li><p><strong>CPU</strong>: AMD EPYC 7J13 64-Core Processor</p></li>
<li><p><strong>Storage</strong>: NFS</p></li>
<li><p><strong>DataSet</strong>: NuScenes-mini, 10 clips, 6 cameras, H.265, 1600x900, GOP_SIZE=30, non-bframe</p></li>
</ul>
</section>
<section id="performance-metrics-frames-sec">
<h3>Performance Metrics (frames/sec)<a class="headerlink" href="#performance-metrics-frames-sec" title="Link to this heading"></a></h3>
<p>Using the Separation Access API, measure the throughput (frames per second) with stream frame access:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>configuration</p></th>
<th class="head"><p>w gop cache</p></th>
<th class="head"><p>w/o gop cache</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1 GPU</p></td>
<td><p>3270.13</p></td>
<td><p>1069.59</p></td>
</tr>
<tr class="row-odd"><td><p>2 GPU</p></td>
<td><p>3699.34</p></td>
<td><p>1881.1</p></td>
</tr>
<tr class="row-even"><td><p>4 GPU</p></td>
<td><p>4337.68</p></td>
<td><p>2809.6</p></td>
</tr>
<tr class="row-odd"><td><p>8 GPU</p></td>
<td><p>4834.13</p></td>
<td><p>3824.36</p></td>
</tr>
</tbody>
</table>
<p>Using the Separation Access API, measure the throughput (frames per second) between stream frame access and random frame access:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>configuration</p></th>
<th class="head"><p>stream access</p></th>
<th class="head"><p>random access</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1 GPU</p></td>
<td><p>3270.13</p></td>
<td><p>311.2</p></td>
</tr>
<tr class="row-odd"><td><p>2 GPU</p></td>
<td><p>3699.34</p></td>
<td><p>603.94</p></td>
</tr>
<tr class="row-even"><td><p>4 GPU</p></td>
<td><p>4337.68</p></td>
<td><p>1220.55</p></td>
</tr>
<tr class="row-odd"><td><p>8 GPU</p></td>
<td><p>4834.13</p></td>
<td><p>2345.44</p></td>
</tr>
</tbody>
</table>
</section>
<section id="performance-optimization-tips">
<h3>Performance Optimization Tips<a class="headerlink" href="#performance-optimization-tips" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>Fork Mode</strong>: Fork or spawn mode both supported; fork recommended for CPU-only demuxing in workers</p></li>
<li><p><strong>GPU Memory</strong>: Only main process requires GPU resources for decoding, workers are CPU-only</p></li>
<li><p><strong>Batch Size</strong>: Adjust <code class="docutils literal notranslate"><span class="pre">group_num</span></code> based on available GPU memory</p></li>
<li><p><strong>Worker Processes</strong>: Adjust <code class="docutils literal notranslate"><span class="pre">num_workers</span></code> based on CPU cores and I/O requirements</p></li>
<li><p><strong>Stream Access Advantage</strong>: Separation decoder efficiently handles stream frame access through packet caching</p></li>
<li><p><strong>GOP Size Impact</strong>: Smaller GOP sizes improve random access performance (less decoding overhead per frame)</p></li>
<li><p><strong>Packet Cache</strong>: GOP packets are cached in the main process, avoiding memory IPC overhead between workers</p></li>
<li><p><strong>Memory Efficiency</strong>: No GPU context duplication across workers, all decoding happens in main process</p></li>
</ul>
</section>
<section id="performance-profiling">
<h3>Performance Profiling<a class="headerlink" href="#performance-profiling" title="Link to this heading"></a></h3>
<p>Use NVIDIA Nsight Systems for detailed performance analysis:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nsys<span class="w"> </span>profile<span class="w"> </span>--trace-fork-before-exec<span class="w"> </span><span class="nb">true</span><span class="w"> </span>-w<span class="w"> </span><span class="nb">true</span><span class="w"> </span>-f<span class="w"> </span><span class="nb">true</span><span class="w"> </span>-t<span class="w"> </span>cuda,nvtx,osrt,cudnn,cublas,nvvideo<span class="w"> </span>--gpu-video-device<span class="w"> </span>all<span class="w"> </span>-x<span class="w"> </span><span class="nb">true</span><span class="w"> </span>-o<span class="w"> </span>dataloader_separation_decode<span class="w"> </span>python<span class="w"> </span>main.py<span class="w"> </span>--index_file<span class="w"> </span>/path/to/index_frame.json
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="dataloader_stream_decode.html" class="btn btn-neutral float-left" title="DataLoader Stream Decode Example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="dataloader_demuxer_free_decode.html" class="btn btn-neutral float-right" title="DataLoader Demuxer-Free Example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, NVIDIA Corporation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>