

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Development Guide &mdash; ACCV-Lab 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=9282052d" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Code Formatting Guide" href="FORMATTING_GUIDE.html" />
    <link rel="prev" title="Docker Guide" href="DOCKER_GUIDE.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ACCV-Lab
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General Info</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../project_overview/README.html">ACCV-Lab Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../guides_index.html">Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="INSTALLATION_GUIDE.html">Installation Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="DOCKER_GUIDE.html">Docker Guide</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Development Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-it-works">How It Works</a></li>
<li class="toctree-l3"><a class="reference internal" href="#package-structure-overview-adding-new-packages">Package Structure Overview &amp; Adding new Packages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#structure">Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-a-new-package-step-by-step-process">Adding a new Package: Step-by-Step Process</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#create-the-directory-structure">1. Create the Directory Structure</a></li>
<li class="toctree-l5"><a class="reference internal" href="#create-the-implementation">2. Create the Implementation</a></li>
<li class="toctree-l5"><a class="reference internal" href="#create-setup-py">3. Create <code class="docutils literal notranslate"><span class="pre">setup.py</span></code></a></li>
<li class="toctree-l5"><a class="reference internal" href="#create-pyproject-toml">4. Create <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code></a></li>
<li class="toctree-l5"><a class="reference internal" href="#define-dependencies-in-pyproject-toml">5. Define Dependencies in <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code></a></li>
<li class="toctree-l5"><a class="reference internal" href="#add-to-namespace-packages-list">6. Add to NAMESPACE_PACKAGES List</a></li>
<li class="toctree-l5"><a class="reference internal" href="#create-tests">7. Create Tests</a></li>
<li class="toctree-l5"><a class="reference internal" href="#set-up-documentation">8. Set Up Documentation</a></li>
<li class="toctree-l5"><a class="reference internal" href="#test-your-package">9. Test Your Package</a></li>
<li class="toctree-l5"><a class="reference internal" href="#build-the-documentation">10. Build the Documentation</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#summary-checklist">Summary Checklist</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#external-implementations">External Implementations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#external-implementation-structure">External Implementation Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#required-components">Required Components</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#build-and-copy-script-build-and-copy-sh">1. Build and Copy Script (<code class="docutils literal notranslate"><span class="pre">build_and_copy.sh</span></code>)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#build-configuration-cmakelists-txt">2. Build Configuration (<code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#integration-with-build-system">Integration with Build System</a></li>
<li class="toctree-l4"><a class="reference internal" href="#external-implementation-best-practices">External Implementation Best Practices</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#error-handling">Error Handling</a></li>
<li class="toctree-l5"><a class="reference internal" href="#path-management">Path Management</a></li>
<li class="toctree-l5"><a class="reference internal" href="#build-reproducibility">Build Reproducibility</a></li>
<li class="toctree-l5"><a class="reference internal" href="#including-external-build-binaries">Including External Build Binaries</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#alternative-skbuild-based-packages">Alternative: SKBuild-Based Packages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#skbuild-package-structure">SKBuild Package Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#skbuild-setup-configuration">SKBuild Setup Configuration</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#setting-up-setup-py-with-skbuild">1. Setting up <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> with SKBuild</a></li>
<li class="toctree-l5"><a class="reference internal" href="#cmakelists-txt-configuration">2. CMakeLists.txt Configuration</a></li>
<li class="toctree-l5"><a class="reference internal" href="#setting-up-pyproject-toml-with-skbuild">3. Setting up <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> with SKBuild</a></li>
<li class="toctree-l5"><a class="reference internal" href="#python-package-structure">4. Python Package Structure</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#skbuild-best-practices">SKBuild Best Practices</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#package-discovery-configuration-cmake-install-configuration">1. Package Discovery Configuration &amp; CMake Install Configuration</a></li>
<li class="toctree-l5"><a class="reference internal" href="#package-discovery-configuration">Package Discovery Configuration</a></li>
<li class="toctree-l5"><a class="reference internal" href="#extension-module-naming">2. Extension Module Naming</a></li>
<li class="toctree-l5"><a class="reference internal" href="#pytorch-integration">3. PyTorch Integration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#comparison-external-implementations-vs-skbuild">Comparison: External Implementations vs. SKBuild</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#skbuild-vs-external-implementations-cmake-based">SKBuild vs. External Implementations (CMake-Based)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#skbuild-vs-external-implementations-workflow-comparison">SKBuild vs. External Implementations: Workflow Comparison</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#external-implementations-workflow">External Implementations Workflow:</a></li>
<li class="toctree-l5"><a class="reference internal" href="#skbuild-workflow">SKBuild Workflow:</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#when-to-use-skbuild-vs-external-implementations">When to Use SKBuild vs. External Implementations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-build-configuration-system">The Build Configuration System</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#purpose-and-benefits">Purpose and Benefits</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shared-build-configuration-utilities">Shared Build &amp; Configuration Utilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage-in-namespace-packages">Usage in Namespace Packages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-build-variables-are-picked-up">How Build Variables Are Picked Up</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-options">Configuration Options</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#development-workflow">Development Workflow</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#testing-during-development">Testing During Development</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#running-tests">Running Tests</a></li>
<li class="toctree-l5"><a class="reference internal" href="#install-in-development-mode">Install in Development Mode</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#documentation-development">Documentation Development</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#code-formatting">Code Formatting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#script-features">Script Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#typical-workflows">Typical Workflows</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#during-development">During Development</a></li>
<li class="toctree-l5"><a class="reference internal" href="#before-committing">Before Committing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#repository-test-runner-scripts-run-tests-sh">Repository Test Runner (<code class="docutils literal notranslate"><span class="pre">scripts/run_tests.sh</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#namespace-package-structure-and-configuration">Namespace Package Structure and Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#understanding-the-package-structure">Understanding the Package Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Package Discovery Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#handling-subpackages">Handling Subpackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#notes">Notes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="FORMATTING_GUIDE.html">Code Formatting Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="DOCUMENTATION_SETUP_GUIDE.html">Sphinx Documentation Setup Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="CONTRIBUTION_GUIDE.html">Contribution Guide</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contained Packages</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contained_package_docs_mirror/on_demand_video_decoder/docs/index.html">On Demand Video Decoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contained_package_docs_mirror/batching_helpers/docs/index.html">Batching Helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contained_package_docs_mirror/dali_pipeline_framework/docs/index.html">DALI Pipeline Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contained_package_docs_mirror/draw_heatmap/docs/index.html">Draw Heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contained_package_docs_mirror/optim_test_tools/docs/index.html">Optimization Testing Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ACCV-Lab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../guides_index.html">Guides</a></li>
      <li class="breadcrumb-item active">Development Guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/guides/DEVELOPMENT_GUIDE.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="development-guide">
<h1>Development Guide<a class="headerlink" href="#development-guide" title="Link to this heading"></a></h1>
<p>This guide covers the development aspects of ACCV-Lab: how the project is structured, how to add new namespace
packages, and how to work with the build system.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong></strong>For installation instructions, see the <a class="reference internal" href="INSTALLATION_GUIDE.html"><span class="std std-doc">Installation Guide</span></a>.</p>
</div>
<section id="how-it-works">
<h2>How It Works<a class="headerlink" href="#how-it-works" title="Link to this heading"></a></h2>
<p>The project uses a shared configuration system where namespace packages are explicitly defined in
<code class="docutils literal notranslate"><span class="pre">namespace_packages_config.py</span></code> (please also note the comments in the code snippet for more details):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># List of all ACCV-Lab namespace packages</span>
<span class="c1"># Each namespace package should:</span>
<span class="c1"># - Be a directory under the packages/ subdirectory</span>
<span class="c1"># - Have a pyproject.toml and setup.py file for building</span>
<span class="c1"># - Be added to this list to be included in builds and documentation</span>
<span class="c1"># Please note that:</span>
<span class="c1"># - Packages that are not listed here will be ignored when installing all packages, building the </span>
<span class="c1">#   documentation, running the tests, etc.</span>
<span class="c1"># - The order in which the packages are listed here is the order in which they will be installed, and in which</span>
<span class="c1">#   they will appear in the documentation.</span>
<span class="n">NAMESPACE_PACKAGES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># The commented out packages below this line are examples (see the development guide):</span>
    <span class="c1">#&#39;accvlab.example_package&#39;,</span>
    <span class="c1">#&#39;accvlab.example_skbuild_package&#39;,</span>
    <span class="s1">&#39;accvlab.on_demand_video_decoder&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accvlab.batching_helpers&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accvlab.dali_pipeline_framework&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accvlab.draw_heatmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accvlab.optim_test_tools&#39;</span><span class="p">,</span>
    <span class="c1"># Add new namespace packages in the same way as above</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Each namespace package is self-contained with its own <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> and <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> files and can be built
and installed independently. The build configuration is handled directly in each package’s <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> using
shared build utilities from the <code class="docutils literal notranslate"><span class="pre">accvlab_build_config</span></code> package (located in the <code class="docutils literal notranslate"><span class="pre">build_config/</span></code> directory
and installed as part of the ACCV-Lab installation) as well as the <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file for the package;
see the <a class="reference internal" href="INSTALLATION_GUIDE.html"><span class="std std-doc">Installation Guide</span></a> for more details on how to build and the
<a class="reference internal" href="#the-build-configuration-system">Build Configuration</a> section for more details on how to use the shared build
utilities inside the package’s <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file.</p>
</section>
<section id="package-structure-overview-adding-new-packages">
<h2>Package Structure Overview &amp; Adding new Packages<a class="headerlink" href="#package-structure-overview-adding-new-packages" title="Link to this heading"></a></h2>
<p>There are two example projects which showcase how a namespace package is structured. These are</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">packages/example_package</span></code>: Showcases a package containing PyTorch extensions built using
<code class="docutils literal notranslate"><span class="pre">CppExtension</span></code> and <code class="docutils literal notranslate"><span class="pre">CUDAExtension</span></code> provided by PyTorch as well as an external implementation (see
<a class="reference internal" href="#external-implementations">External Implementations</a> section for more details on external implementations)
as described below.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">packages/example_skbuild_package</span></code>: Showcases a package using <code class="docutils literal notranslate"><span class="pre">scikit-build</span></code> for C++/CUDA implementation
(see the <a class="reference internal" href="#alternative-skbuild-based-packages">Alternative: SKBuild-Based Packages</a> section for more
details on this approach).</p></li>
</ul>
<p>First, we will focus on the <code class="docutils literal notranslate"><span class="pre">example_package</span></code>, and explain how to set it up from scratch.
For <code class="docutils literal notranslate"><span class="pre">scikit-build</span></code> based packages, the setup is similar. The SKBuild-based approach is described in the
<a class="reference internal" href="#alternative-skbuild-based-packages">Alternative: SKBuild-Based Packages</a> section.</p>
<section id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h3>
<p>To add a new namespace package (e.g., <code class="docutils literal notranslate"><span class="pre">example_package</span></code>), you need to create:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Component</p></th>
<th class="head"><p>Directory</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Implementation</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">packages/example_package/accvlab/example_package/</span></code></p></td>
<td><p>Python package with your actual code</p></td>
</tr>
<tr class="row-odd"><td><p><strong>External Implementation</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">packages/example_package/ext_impl/</span></code></p></td>
<td><p>Parts of the package which are built externally (e.g. using CMake) and then copied to the main package</p></td>
</tr>
<tr class="row-even"><td><p><strong>Documentation</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">packages/example_package/docs/</span></code></p></td>
<td><p>API reference and user guides (template will be auto-generated)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Tests</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">packages/example_package/tests/</span></code></p></td>
<td><p>Unit tests (will be automatically picked up by the test runner)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Setup</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">packages/example_package/setup.py</span></code></p></td>
<td><p>Package build configuration</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Project Config</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">packages/example_package/pyproject.toml</span></code></p></td>
<td><p>Modern Python project configuration and authoritative dependency definition</p></td>
</tr>
<tr class="row-even"><td><p><strong>Documentation include list (optional)</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">packages/example_package/docu_referenced_dirs.txt</span></code></p></td>
<td><p>List additional directories referenced by the docs (besides <code class="docutils literal notranslate"><span class="pre">docs/</span></code>). See <a class="reference internal" href="DOCUMENTATION_SETUP_GUIDE.html"><span class="std std-doc">Documentation Setup Guide</span></a> for more details.</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong></strong>Apart from the above, further folders/files can be included (and made use of manually or added to the
documentation) if needed. A typical use case is to include e.g. an <code class="docutils literal notranslate"><span class="pre">examples</span></code> directory which is:</p>
<ul class="simple">
<li><p>Referenced by the documentation (added to <code class="docutils literal notranslate"><span class="pre">docu_referenced_dirs.txt</span></code>) and from which code snippets are
included in the documentation.</p></li>
<li><p>Can be used directly by navigating to the <code class="docutils literal notranslate"><span class="pre">examples/</span></code> directory and running the contained code.</p></li>
</ul>
</div>
</section>
<section id="structure">
<h3>Structure<a class="headerlink" href="#structure" title="Link to this heading"></a></h3>
<p>The following diagram shows the relevant project structure containing the folders which correspond to the
<code class="docutils literal notranslate"><span class="pre">example_package</span></code> namespace package:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>accvlab/
├── packages/                        # Namespace packages directory
│   ├── optim_test_tools/...
│   ├── batching_helpers/...
│   └── example_package/             # ← New namespace package
│       ├── accvlab/                 # ← Namespace root
│       │   └── example_package/     # ← Implementation for &quot;example_package&quot; package
│       │       ├── __init__.py
│       │       ├── csrc/            # ← C++/CUDA sources
│       │       └── include/         # ← Headers
│       ├── ext_impl/                # ← Optional: external implementation
│       │   ├── build_and_copy.sh
│       │   └── ...
│       ├── tests/                   # ← Tests for &quot;example_package&quot; package
│       ├── docs/                    # ← Documentation for &quot;example_package&quot; package
│       ├── setup.py                 # ← Package build configuration
│       ├── pyproject.toml           # ← Project configuration (including dependencies)
│       └── docu_referenced_dirs.txt # ← Optional: list additional directories referenced by the docs (besides `docs/`)
├── build_config/                    # Shared build utilities
├── docs/                            # Main documentation
└── namespace_packages_config.py     # ← Namespace package needs to be listed here
</pre></div>
</div>
<p>Note that inside the package, there is the directory structure <code class="docutils literal notranslate"><span class="pre">accvlab/example_package</span></code>. This is where the
Python implementation of the namespace package is located, and it is named according to the package name (in
this case <code class="docutils literal notranslate"><span class="pre">accvlab.example_package</span></code>). Other packages are structured in the same way, with <code class="docutils literal notranslate"><span class="pre">example_package</span></code>
replaced by the name of the respective package.</p>
</section>
<section id="adding-a-new-package-step-by-step-process">
<h3>Adding a new Package: Step-by-Step Process<a class="headerlink" href="#adding-a-new-package-step-by-step-process" title="Link to this heading"></a></h3>
<p>To add a new namespace package (e.g., <code class="docutils literal notranslate"><span class="pre">example_package</span></code>):</p>
<section id="create-the-directory-structure">
<h4>1. Create the Directory Structure<a class="headerlink" href="#create-the-directory-structure" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the namespace package directory</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>packages/example_package
mkdir<span class="w"> </span>-p<span class="w"> </span>packages/example_package/accvlab/example_package<span class="w">           </span><span class="c1"># For the implementation</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>packages/example_package/accvlab/example_package/csrc<span class="w">      </span><span class="c1"># For C++/CUDA sources</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>packages/example_package/accvlab/example_package/include<span class="w">   </span><span class="c1"># For headers</span>

<span class="c1"># External implementation directory (optional - see External Implementations section)</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>packages/example_package/ext_impl

<span class="c1"># Documentation include list file (optional - see Documentation Setup Guide)</span>
touch<span class="w"> </span>packages/example_package/docu_referenced_dirs.txt

<span class="c1"># Examples directory (optional - see Documentation Setup Guide)</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>packages/example_package/examples<span class="w">                   </span>

<span class="c1"># Tests directory</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>packages/example_package/tests

<span class="c1"># Documentation directory created automatically by docs system as:</span>
<span class="c1">#   packages/example_package/docs/</span>
</pre></div>
</div>
</section>
<section id="create-the-implementation">
<h4>2. Create the Implementation<a class="headerlink" href="#create-the-implementation" title="Link to this heading"></a></h4>
<p>Add your implementation in the <code class="docutils literal notranslate"><span class="pre">packages/example_package/accvlab/example_package</span></code> folder (including the
package’s Python code and native extensions using the <code class="docutils literal notranslate"><span class="pre">CppExtension</span></code> and <code class="docutils literal notranslate"><span class="pre">CUDAExtension</span></code> approach if
applicable).</p>
<p>If more complex C++/CUDA implementations are used, an external implementation can be added in
<code class="docutils literal notranslate"><span class="pre">packages/example_package/ext_impl</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong></strong>For complex C++/CUDA implementations that require custom build procedures, third-party libraries,
or CMake-based builds, there are two alternatives:</p>
</div>
<ol class="arabic simple">
<li><p><strong>External Implementations</strong> - Uses custom build scripts and CMake (used in this example)</p></li>
<li><p><strong>SKBuild-based packages</strong> - Uses <code class="docutils literal notranslate"><span class="pre">scikit-build</span></code> for CMake integration</p></li>
</ol>
<p>Both approaches are described in detail later in this guide. The <code class="docutils literal notranslate"><span class="pre">example_package</span></code> uses the External
Implementations approach. For more details, see:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#external-implementations">External Implementations</a> section for the approach used in this example</p></li>
<li><p><a class="reference internal" href="#alternative-skbuild-based-packages">Alternative: SKBuild-Based Packages</a> section for the SKBuild approach</p></li>
<li><p><a class="reference internal" href="#comparison-external-implementations-vs-skbuild">Comparison: External Implementations vs. SKBuild</a> section
for a detailed comparison of both approaches</p></li>
</ul>
</section>
<section id="create-setup-py">
<h4>3. Create <code class="docutils literal notranslate"><span class="pre">setup.py</span></code><a class="headerlink" href="#create-setup-py" title="Link to this heading"></a></h4>
<p>Create the setup configuration file that defines how to compile C++/CUDA extensions and configure any external
builds. See <code class="docutils literal notranslate"><span class="pre">packages/example_package/setup.py</span></code> for a complete working example.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong></strong>If your package uses external builds (see <a class="reference internal" href="#external-implementations">External Implementations</a>
section), you need to:</p>
<ul class="simple">
<li><p>Call <code class="docutils literal notranslate"><span class="pre">run_external_build()</span></code> before calling <code class="docutils literal notranslate"><span class="pre">setup()</span></code> to ensure that the external binaries are included in
the resulting package.</p></li>
<li><p>Include the parameters as shown below to the call to <code class="docutils literal notranslate"><span class="pre">setup()</span></code> (with <code class="docutils literal notranslate"><span class="pre">example_package</span></code> replaced by your
package’s name).</p></li>
</ul>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">run_external_build</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="o">...</span>
    <span class="n">include_package_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">package_data</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;accvlab.example_package&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;*.so&#39;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">zip_safe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">....</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The first 2 arguments ensure that the external binaries are included, while the last argument ensures that the
package is not stored as a zip-file, which would prevent the external binaries from being imported correctly.</p>
</section>
<section id="create-pyproject-toml">
<h4>4. Create <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code><a class="headerlink" href="#create-pyproject-toml" title="Link to this heading"></a></h4>
<p>Create the Python project configuration. This file also defines the package’s runtime and optional dependencies.
See <code class="docutils literal notranslate"><span class="pre">packages/example_package/pyproject.toml</span></code> for a complete working example.</p>
</section>
<section id="define-dependencies-in-pyproject-toml">
<h4>5. Define Dependencies in <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code><a class="headerlink" href="#define-dependencies-in-pyproject-toml" title="Link to this heading"></a></h4>
<p>Add your package dependencies to the <code class="docutils literal notranslate"><span class="pre">[project]</span></code> section of <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>. For example, the
<code class="docutils literal notranslate"><span class="pre">packages/example_package/pyproject.toml</span></code> file contains:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[project]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;accvlab.example_package&quot;</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span>
<span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ACCV-Lab Example Package&quot;</span>
<span class="n">requires-python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=3.8&quot;</span>
<span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;torch&gt;=2.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;numpy&gt;=1.22.2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;accvlab-build-config&gt;=0.1.0&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">[project.optional-dependencies]</span>
<span class="n">optional</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;pytest&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Use this pattern for your own namespace package, adapting the dependency names and versions as needed.</p>
</section>
<section id="add-to-namespace-packages-list">
<h4>6. Add to NAMESPACE_PACKAGES List<a class="headerlink" href="#add-to-namespace-packages-list" title="Link to this heading"></a></h4>
<p>This ensures that your package is included in various places, e.g.</p>
<ul class="simple">
<li><p>in the installation by the <code class="docutils literal notranslate"><span class="pre">package_manager.sh</span></code> script</p></li>
<li><p>in the documentation</p></li>
<li><p>in the code formatting by the <code class="docutils literal notranslate"><span class="pre">format.sh</span></code> script</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In namespace_packages_config.py</span>
<span class="n">NAMESPACE_PACKAGES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;accvlab.optim_test_tools&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accvlab.batching_helpers&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accvlab.dali_pipeline_framework&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accvlab.on_demand_video_decoder&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accvlab.example_package&#39;</span><span class="p">,</span>  <span class="c1"># Add your new namespace package here</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="create-tests">
<h4>7. Create Tests<a class="headerlink" href="#create-tests" title="Link to this heading"></a></h4>
<p>Create test files for your namespace package. See <code class="docutils literal notranslate"><span class="pre">packages/example_package/tests/</span></code> for examples.</p>
<p>Note that this includes only tests for the Python functionality. If you use C++ tests, please ensure
that they are performed during the build and in case of external implementation, that
the <code class="docutils literal notranslate"><span class="pre">build_and_copy.sh</span></code> script returns an error code (e.g. a value != 0) if tests fail.</p>
</section>
<section id="set-up-documentation">
<h4>8. Set Up Documentation<a class="headerlink" href="#set-up-documentation" title="Link to this heading"></a></h4>
<p>The documentation system will automatically create the structure when you add the namespace package and build
the documentation (see the <a class="reference internal" href="DOCUMENTATION_SETUP_GUIDE.html"><span class="std std-doc">Documentation Setup Guide</span></a> for more details).</p>
<p>Alternatively, you can generate the documentation structure manually using the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate documentation structure for the new namespace package</span>
<span class="nb">cd</span><span class="w"> </span>docs<span class="w"> </span><span class="c1"># ← Assuming you are in the main docs directory (not the package&#39;s docs directory)</span>
python3<span class="w"> </span>generate_new_namespace_package_docs.py
python3<span class="w"> </span>update_docs_index.py
</pre></div>
</div>
<p>This creates:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">packages/example_package/docs/index.rst</span></code> - Table of contents (needs to be present; can be edited if needed)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">packages/example_package/docs/intro.rst</span></code> - Manual introduction (customize this!)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">packages/example_package/docs/api.rst</span></code> - Auto-generated API reference (can be edited if needed)</p></li>
</ul>
<p><strong>Customize the introduction:</strong>
Edit <code class="docutils literal notranslate"><span class="pre">packages/example_package/docs/intro.rst</span></code> to add</p>
<ul class="simple">
<li><p>Package overview and purpose</p></li>
<li><p>Basic usage examples</p></li>
<li><p>Performance characteristics</p></li>
<li><p>Integration notes</p></li>
</ul>
<p>Note that you are mostly free to modify, add, or remove the files &amp; their contents of the documentation.
However, <code class="docutils literal notranslate"><span class="pre">index.rst</span></code> serves as the “entry point” for the documentation and needs to be present.</p>
<p>Most of the contained packages extend this basic structure considerably to provide more detailed
documentation. Please see the <a class="reference internal" href="DOCUMENTATION_SETUP_GUIDE.html"><span class="std std-doc">Documentation Setup Guide</span></a> for more details on
the documentation system and how to set it up.</p>
</section>
<section id="test-your-package">
<h4>9. Test Your Package<a class="headerlink" href="#test-your-package" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Install the package with your new namespace package</span>
<span class="nb">cd</span><span class="w"> </span>packages/example_package
<span class="c1"># IMPORTANT: Do not use  editable installation (`-e`) for SKBuild-based packages (e.g. </span>
<span class="c1"># `on_demand_video_decoder` or `dali_pipeline_framework`), as it would lead to missing binaries and import </span>
<span class="c1"># errors. </span>
<span class="c1"># It is ok to use `-e` for other packages. However, keep in mind that for any changes in C++ code to take </span>
<span class="c1"># effect, the package needs to be re-installed regardless of whether it is installed in editable mode or not.</span>
pip<span class="w"> </span>install<span class="w"> </span>.<span class="w"> </span>--no-build-isolation<span class="w"> </span>

<span class="c1"># 2. Run tests</span>
pytest<span class="w"> </span>tests/<span class="w"> </span>-v
</pre></div>
</div>
</section>
<section id="build-the-documentation">
<h4>10. Build the Documentation<a class="headerlink" href="#build-the-documentation" title="Link to this heading"></a></h4>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong></strong>Ensure all configured namespace packages are installed before building the docs.
For detailed instructions (commands and development targets), see the
<a class="reference internal" href="DOCUMENTATION_SETUP_GUIDE.html#building-documentation-locally"><span class="std std-ref">Documentation Setup Guide</span></a>.</p>
</div>
</section>
</section>
<section id="summary-checklist">
<h3>Summary Checklist<a class="headerlink" href="#summary-checklist" title="Link to this heading"></a></h3>
<p>When adding a new namespace package, ensure you have:</p>
<ul class="contains-task-list simple">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>Implementation</strong>: <code class="docutils literal notranslate"><span class="pre">packages/example_package/accvlab/example_package/</span></code> with <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> and source
code</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>Setup</strong>: <code class="docutils literal notranslate"><span class="pre">packages/example_package/setup.py</span></code> with build configuration</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>Project Config</strong>: <code class="docutils literal notranslate"><span class="pre">packages/example_package/pyproject.toml</span></code> with project metadata</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>Configuration</strong>: Added to <code class="docutils literal notranslate"><span class="pre">namespace_packages_config.py</span></code></p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>Tests</strong>: <code class="docutils literal notranslate"><span class="pre">packages/example_package/tests/</span></code> with test files</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>Documentation</strong>: Generated with docs scripts and customized intro</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>Documentation include list (optional)</strong>: <code class="docutils literal notranslate"><span class="pre">docu_referenced_dirs.txt</span></code> created and populated if extra
folders (e.g. <code class="docutils literal notranslate"><span class="pre">examples/</span></code>) are referenced</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>Examples (optional)</strong>: <code class="docutils literal notranslate"><span class="pre">packages/&lt;package_name&gt;/examples/</span></code> created and referenced from docs if used</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>Dependencies</strong>: Declared runtime and optional dependencies in <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code></p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>External implementation</strong>: (Optional) <code class="docutils literal notranslate"><span class="pre">packages/example_package/ext_impl/</span></code> for external builds</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>External build binaries</strong>: (If using external builds) <code class="docutils literal notranslate"><span class="pre">include_package_data=True</span></code> and <code class="docutils literal notranslate"><span class="pre">package_data</span></code>
configuration in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code></p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> <strong>Verification</strong>: Package installs, tests pass, docs build</p></li>
</ul>
</section>
</section>
<section id="external-implementations">
<h2>External Implementations<a class="headerlink" href="#external-implementations" title="Link to this heading"></a></h2>
<p>External implementations provide a way to build complex components outside of the standard Python/pybind11
workflow and then integrate them into your namespace package. This is particularly useful for:</p>
<ul class="simple">
<li><p><strong>Complex CMake projects</strong> with multiple dependencies</p></li>
<li><p><strong>Third-party libraries</strong> that need specific build configurations</p></li>
<li><p><strong>Other cases with the need for flexible manual setups</strong></p></li>
</ul>
<p>For relatively small and self-contained C++/CUDA implementations, consider using PyTorch’s <code class="docutils literal notranslate"><span class="pre">CppExtension</span></code> and
<code class="docutils literal notranslate"><span class="pre">CUDAExtension</span></code> instead.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong></strong>This section describes the External Implementations approach used in the <code class="docutils literal notranslate"><span class="pre">example_package</span></code>. For an
alternative approach using <code class="docutils literal notranslate"><span class="pre">scikit-build</span></code>, see the
<a class="reference internal" href="#alternative-skbuild-based-packages">Alternative: SKBuild-Based Packages</a> section. A detailed comparison of
both approaches is available in the
<a class="reference internal" href="#comparison-external-implementations-vs-skbuild">Comparison: External Implementations vs. SKBuild</a> section.</p>
</div>
<section id="external-implementation-structure">
<h3>External Implementation Structure<a class="headerlink" href="#external-implementation-structure" title="Link to this heading"></a></h3>
<p>External implementations are located in the <code class="docutils literal notranslate"><span class="pre">packages/example_package/ext_impl/</span></code> directory. An example is
shown below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>accvlab/
├── packages/
│   └── example_package/
│       ├── ...
│       ├── setup.py
│       ├── pyproject.toml
│       └── ext_impl/
│           ├── build_and_copy.sh
│           ├── CMakeLists.txt
│           ├── src/
│           │   ├── external_algo.cpp
│           │   └── external_algo.cu
│           ├── include/
│           │   └── external_algo.h
│           ├── third_party/
│           └── build/
</pre></div>
</div>
</section>
<section id="required-components">
<h3>Required Components<a class="headerlink" href="#required-components" title="Link to this heading"></a></h3>
<section id="build-and-copy-script-build-and-copy-sh">
<h4>1. Build and Copy Script (<code class="docutils literal notranslate"><span class="pre">build_and_copy.sh</span></code>)<a class="headerlink" href="#build-and-copy-script-build-and-copy-sh" title="Link to this heading"></a></h4>
<p>Every external implementation must have this script,
which handles the external build process and copies results to the main package. See
<code class="docutils literal notranslate"><span class="pre">packages/example_package/ext_impl/build_and_copy.sh</span></code> for a complete working example.</p>
</section>
<section id="build-configuration-cmakelists-txt">
<h4>2. Build Configuration (<code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>)<a class="headerlink" href="#build-configuration-cmakelists-txt" title="Link to this heading"></a></h4>
<p>Typically, the external build is performed using <code class="docutils literal notranslate"><span class="pre">CMake</span></code> (although this is not strictly necessary).
See <code class="docutils literal notranslate"><span class="pre">packages/example_package/ext_impl/CMakeLists.txt</span></code> for a complete working example.</p>
</section>
</section>
<section id="integration-with-build-system">
<h3>Integration with Build System<a class="headerlink" href="#integration-with-build-system" title="Link to this heading"></a></h3>
<p>External implementations are automatically handled by the main <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> in a generic manner (by calling
<code class="docutils literal notranslate"><span class="pre">accvlab_build_config.run_external_build()</span></code>). Please ensure that you set up the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> correctly (as
described in the <a class="reference internal" href="#create-setup-py">setup.py configuration</a> section above).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong></strong>External implementations can be used alongside standard C++/CUDA extensions in the same namespace
package. You can combine both approaches - use external implementations for complex components while still
having standard extensions for simpler functionality.</p>
</div>
<p>The setup process works as follows:</p>
<ol class="arabic simple">
<li><p><strong>Selective Detection</strong>: <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> detects whether an external implementation is present and calls the
<code class="docutils literal notranslate"><span class="pre">build_and_copy.sh</span></code> script (which is responsible for building &amp; inserting the binaries into the package).</p></li>
<li><p><strong>Standard Processing</strong>: After the external build completes for a namespace package, the obtained binaries
are inside the package, and standard installation (including extension processing) can be used. Note
that the build binaries are copied to the installed package if <code class="docutils literal notranslate"><span class="pre">setup()</span></code> is called with the correct
parameters (see the <a class="reference internal" href="#create-setup-py">setup.py configuration</a> section above).</p></li>
</ol>
<p>This means your <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> remains simple, and only the changes described in the
<a class="reference internal" href="#create-setup-py">setup.py configuration</a> section above are needed to use external implementations.</p>
<p><strong>Key Points:</strong></p>
<ul class="simple">
<li><p>External implementations are only built for namespace packages listed in <code class="docutils literal notranslate"><span class="pre">namespace_packages_config.py</span></code> (as
installation is only triggered for those).</p></li>
<li><p>External builds are executed <strong>before</strong> each namespace package’s call to <code class="docutils literal notranslate"><span class="pre">setup()</span></code>, i.e. before potential
extension processing.</p></li>
<li><p>The external build script copies its outputs to the main package directory.</p></li>
<li><p><strong>External implementations can coexist with standard extensions</strong> - you can have both in the same namespace
package.</p></li>
<li><p>No special external build logic is needed in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, only ensure to call <code class="docutils literal notranslate"><span class="pre">run_external_build()</span></code> and
ensure the resulting files are included in the package (see <a class="reference internal" href="#create-setup-py">setup.py configuration</a>).</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong></strong>The fact that external builds are performed before calls to <code class="docutils literal notranslate"><span class="pre">setup()</span></code> and are copied into the
package means that it is possible to use the external builds inside standard PyTorch extensions built with
<code class="docutils literal notranslate"><span class="pre">CppExtension</span></code> and <code class="docutils literal notranslate"><span class="pre">CUDAExtension</span></code>.</p>
</div>
</section>
<section id="external-implementation-best-practices">
<h3>External Implementation Best Practices<a class="headerlink" href="#external-implementation-best-practices" title="Link to this heading"></a></h3>
<section id="error-handling">
<h4>Error Handling<a class="headerlink" href="#error-handling" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">-e</span></code> in build scripts to fail fast on errors</p></li>
<li><p>Provide clear error messages for build failures</p></li>
<li><p>Check for required tools and dependencies before building</p></li>
</ul>
</section>
<section id="path-management">
<h4>Path Management<a class="headerlink" href="#path-management" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Make scripts work from any working directory</p></li>
<li><p>Use variables for commonly referenced paths</p></li>
</ul>
</section>
<section id="build-reproducibility">
<h4>Build Reproducibility<a class="headerlink" href="#build-reproducibility" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Pin dependency versions where possible</p></li>
<li><p>Use consistent compiler flags and options</p></li>
<li><p>Clean build directories before building</p></li>
</ul>
</section>
<section id="including-external-build-binaries">
<h4>Including External Build Binaries<a class="headerlink" href="#including-external-build-binaries" title="Link to this heading"></a></h4>
<p>When using external builds, you must configure <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> to include the built binaries in the installed
package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span>
    <span class="c1"># ... other configuration ...</span>
    
    <span class="c1"># `include_package_data` and `package_data` are needed for the binaries created by the external build</span>
    <span class="c1"># to be included in the package.</span>
    <span class="n">include_package_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">package_data</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;accvlab.example_package&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;*.so&#39;</span><span class="p">],</span>  <span class="c1"># Include all .so files in the package</span>
    <span class="p">},</span>
    <span class="n">zip_safe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>

    <span class="c1"># ... rest of configuration ...</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong></strong>Without this configuration, the binaries created by external builds will not be included in the
installed package, causing import errors when users try to use your package.</p>
</div>
<p><strong>Pattern matching</strong>: The <code class="docutils literal notranslate"><span class="pre">package_data</span></code> configuration uses glob patterns to match files. Common patterns:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">['*.so']</span></code> - Include all shared object files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">['lib/*.so']</span></code> - Include .so files in a lib subdirectory</p></li>
</ul>
</section>
</section>
</section>
<section id="alternative-skbuild-based-packages">
<h2>Alternative: SKBuild-Based Packages<a class="headerlink" href="#alternative-skbuild-based-packages" title="Link to this heading"></a></h2>
<p>You can also use <strong>SKBuild</strong> (scikit-build) instead of the external implementation approach discussed above.
See <code class="docutils literal notranslate"><span class="pre">packages/example_skbuild_package/</span></code> for a complete example. Note that SKBuild-based packages cannot be
used in combination with PyTorch’s <code class="docutils literal notranslate"><span class="pre">CppExtension</span></code> and <code class="docutils literal notranslate"><span class="pre">CUDAExtension</span></code> in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>. All PyTorch extensions
must be set up as targets in the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> instead.</p>
<p>SKBuild packages:</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">skbuild</span> <span class="pre">import</span> <span class="pre">setup</span></code> instead of <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">setuptools</span> <span class="pre">import</span> <span class="pre">setup</span></code></p></li>
<li><p>Include <code class="docutils literal notranslate"><span class="pre">cmake_source_dir</span></code> and <code class="docutils literal notranslate"><span class="pre">cmake_install_dir</span></code> parameters in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> (see below for details)</p></li>
<li><p>Use CMake for building C++/CUDA extensions</p></li>
<li><p>Don’t require additional <code class="docutils literal notranslate"><span class="pre">build_and_copy.sh</span></code> scripts (and calls to <code class="docutils literal notranslate"><span class="pre">run_external_build()</span></code>), simplifying
the setup</p></li>
</ul>
<section id="skbuild-package-structure">
<h3>SKBuild Package Structure<a class="headerlink" href="#skbuild-package-structure" title="Link to this heading"></a></h3>
<p>An SKBuild-based package follows this structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>packages/example_skbuild_package/
├── ...
├── setup.py
├── pyproject.toml
└── ext_impl/
    ├── CMakeLists.txt
    ├── src/
    │   ├── external_cuda_ops.cpp
    │   └── external_cuda_ops.cu
    └── include/
        └── external_cuda_ops.h
</pre></div>
</div>
</section>
<section id="skbuild-setup-configuration">
<h3>SKBuild Setup Configuration<a class="headerlink" href="#skbuild-setup-configuration" title="Link to this heading"></a></h3>
<section id="setting-up-setup-py-with-skbuild">
<h4>1. Setting up <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> with SKBuild<a class="headerlink" href="#setting-up-setup-py-with-skbuild" title="Link to this heading"></a></h4>
<p>See <code class="docutils literal notranslate"><span class="pre">packages/example_skbuild_package/setup.py</span></code> for a complete working example.</p>
<p><strong>Key Differences from the external implementation-based approach</strong>:</p>
<ul class="simple">
<li><p>No <code class="docutils literal notranslate"><span class="pre">run_external_build()</span></code> calls</p></li>
<li><p>No <code class="docutils literal notranslate"><span class="pre">package_data</span></code> configuration (SKBuild handles this automatically)</p></li>
<li><p>Uses <code class="docutils literal notranslate"><span class="pre">cmake_source_dir</span></code> and <code class="docutils literal notranslate"><span class="pre">cmake_install_dir</span></code> parameters in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>. Please see the
<a class="reference internal" href="#important-note-for-cmake-install-configuration">important note for cmake install configuration</a>
section below for details on how these parameters need to be configured.</p></li>
<li><p>Cannot be used in combination with PyTorch’s <code class="docutils literal notranslate"><span class="pre">CppExtension</span></code> and <code class="docutils literal notranslate"><span class="pre">CUDAExtension</span></code> in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>. The
extensions must be set up as targets in the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>.</p></li>
</ul>
</section>
<section id="cmakelists-txt-configuration">
<h4>2. CMakeLists.txt Configuration<a class="headerlink" href="#cmakelists-txt-configuration" title="Link to this heading"></a></h4>
<p>See <code class="docutils literal notranslate"><span class="pre">packages/example_skbuild_package/ext_impl/CMakeLists.txt</span></code> for a complete working example.</p>
<p><strong>Key Differences from External Implementations</strong>:</p>
<ul class="simple">
<li><p>The overall setup is simpler - no need for <code class="docutils literal notranslate"><span class="pre">build_and_copy.sh</span></code>, i.e. no manual path calculations or copying
of files</p></li>
<li><p>Install target needs to be set up (see the
<a class="reference internal" href="#important-note-for-cmake-install-configuration">important note for cmake install configuration</a>).</p></li>
</ul>
</section>
<section id="setting-up-pyproject-toml-with-skbuild">
<h4>3. Setting up <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> with SKBuild<a class="headerlink" href="#setting-up-pyproject-toml-with-skbuild" title="Link to this heading"></a></h4>
<p>See <code class="docutils literal notranslate"><span class="pre">packages/example_skbuild_package/pyproject.toml</span></code> for a complete working example.</p>
<p><strong>Key Difference from External Implementations</strong>: Includes <code class="docutils literal notranslate"><span class="pre">scikit-build</span></code> and <code class="docutils literal notranslate"><span class="pre">pybind11</span></code> as build
requirements.</p>
</section>
<section id="python-package-structure">
<h4>4. Python Package Structure<a class="headerlink" href="#python-package-structure" title="Link to this heading"></a></h4>
<p>See <code class="docutils literal notranslate"><span class="pre">packages/example_skbuild_package/accvlab/example_skbuild_package/__init__.py</span></code> and
<code class="docutils literal notranslate"><span class="pre">packages/example_skbuild_package/accvlab/example_skbuild_package/functions/functions.py</span></code> for complete working
examples.</p>
<p>This is similar to the external implementation-based case in that a binary is present in the final package,
which can be imported in Python and exposes relevant functionality as defined in the C++ implementation using
<code class="docutils literal notranslate"><span class="pre">pybind11</span></code>.</p>
</section>
</section>
<section id="skbuild-best-practices">
<h3>SKBuild Best Practices<a class="headerlink" href="#skbuild-best-practices" title="Link to this heading"></a></h3>
<section id="package-discovery-configuration-cmake-install-configuration">
<h4>1. Package Discovery Configuration &amp; CMake Install Configuration<a class="headerlink" href="#package-discovery-configuration-cmake-install-configuration" title="Link to this heading"></a></h4>
</section>
<section id="package-discovery-configuration">
<h4>Package Discovery Configuration<a class="headerlink" href="#package-discovery-configuration" title="Link to this heading"></a></h4>
<p>SKBuild requires careful configuration to ensure extensions are placed correctly in the final package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In setup.py</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="c1"># ... other configuration ...</span>
    <span class="n">cmake_install_dir</span><span class="o">=</span><span class="s2">&quot;accvlab/example_skbuild_package&quot;</span><span class="p">,</span>  <span class="c1"># Must match package structure</span>
<span class="p">)</span>
</pre></div>
</div>
<section id="cmake-install-configuration">
<h5>CMake Install Configuration<a class="headerlink" href="#cmake-install-configuration" title="Link to this heading"></a></h5>
<p>The CMake install target must match the <code class="docutils literal notranslate"><span class="pre">cmake_install_dir</span></code>. Note that this directory is the working as used
when setting up the <code class="docutils literal notranslate"><span class="pre">install</span></code> target in the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>, so that the path needs to be set to <code class="docutils literal notranslate"><span class="pre">.</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Install target - destination must be relative to cmake_install_dir</span>
<span class="nb">install</span><span class="p">(</span><span class="s">TARGETS</span><span class="w"> </span><span class="s">accvlab_example_skbuild_package_ext</span>
<span class="w">    </span><span class="s">LIBRARY</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">.</span><span class="w">  </span><span class="c"># Installs to cmake_install_dir</span>
<span class="w">    </span><span class="s">RUNTIME</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">.</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="important-note-for-cmake-install-configuration">
<h5>Important Note for CMake Install Configuration<a class="headerlink" href="#important-note-for-cmake-install-configuration" title="Link to this heading"></a></h5>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">cmake_install_dir</span></code> (set to <code class="docutils literal notranslate"><span class="pre">accvlab/example_skbuild_package</span></code>) in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> and the CMake
installation directory (set to <code class="docutils literal notranslate"><span class="pre">.</span></code>) in <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> must point to the same directory in order for the
binary to be included in the wheel in the correct way (i.e. not as <code class="docutils literal notranslate"><span class="pre">data</span></code>). If this is not the case, it cannot
be imported from the installed package.</p>
<p>However, the paths in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> and <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> both use relative paths, but relative to different base
locations. While the <code class="docutils literal notranslate"><span class="pre">cmake_install_dir</span></code> in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> relative to that <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, the CMake install
configuration is relative to the package root. The package root is located at
<code class="docutils literal notranslate"><span class="pre">accvlab/example_skbuild_package</span></code> (relative to the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>) in this case (and in general at
<code class="docutils literal notranslate"><span class="pre">accvlab/&lt;package_name&gt;</span></code> for the setup used in this repo). Therefore, the general guideline is:</p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, set <code class="docutils literal notranslate"><span class="pre">cmake_install_dir</span></code> to the root of the package (i.e. <code class="docutils literal notranslate"><span class="pre">accvlab/&lt;package_name&gt;</span></code>)</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>, set the installation directory to <code class="docutils literal notranslate"><span class="pre">.</span></code>.</p></li>
</ul>
</section>
</section>
<section id="extension-module-naming">
<h4>2. Extension Module Naming<a class="headerlink" href="#extension-module-naming" title="Link to this heading"></a></h4>
<p>Ensure the extension module name matches Python import expectations:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Set output name to match Python import</span>
<span class="nb">set_target_properties</span><span class="p">(</span><span class="s">accvlab_example_skbuild_package_ext</span><span class="w"> </span><span class="s">PROPERTIES</span>
<span class="w">    </span><span class="s">OUTPUT_NAME</span><span class="w"> </span><span class="s2">&quot;_ext&quot;</span><span class="w">  </span><span class="c"># Results in _ext.so</span>
<span class="w">    </span><span class="s">PREFIX</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w">           </span><span class="c"># No lib prefix</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="pytorch-integration">
<h4>3. PyTorch Integration<a class="headerlink" href="#pytorch-integration" title="Link to this heading"></a></h4>
<p>For PyTorch extensions, ensure proper CMake configuration:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Find PyTorch CMake files</span>
<span class="nb">execute_process</span><span class="p">(</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="s2">&quot;python3&quot;</span><span class="w"> </span><span class="s">-c</span><span class="w"> </span><span class="s2">&quot;import torch; import os; print(os.path.join(os.path.dirname(torch.__file__), &#39;share&#39;, &#39;cmake&#39;))&quot;</span>
<span class="w">    </span><span class="s">OUTPUT_VARIABLE</span><span class="w"> </span><span class="s">TORCH_CMAKE_PATH</span>
<span class="w">    </span><span class="s">OUTPUT_STRIP_TRAILING_WHITESPACE</span>
<span class="p">)</span>
<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">CMAKE_PREFIX_PATH</span><span class="w"> </span><span class="s2">&quot;${TORCH_CMAKE_PATH}&quot;</span><span class="p">)</span>

<span class="c"># Add PyTorch extension definitions</span>
<span class="nb">target_compile_definitions</span><span class="p">(</span><span class="s">accvlab_example_skbuild_package_ext</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span>
<span class="w">    </span><span class="s">TORCH_EXTENSION_NAME=_ext</span>
<span class="w">    </span><span class="s">TORCH_API_INCLUDE_EXTENSION_H</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="comparison-external-implementations-vs-skbuild">
<h2>Comparison: External Implementations vs. SKBuild<a class="headerlink" href="#comparison-external-implementations-vs-skbuild" title="Link to this heading"></a></h2>
<p>Both External Implementations and SKBuild use CMake for building C++/CUDA extensions, but they differ
significantly in how they integrate with Python packaging:</p>
<section id="skbuild-vs-external-implementations-cmake-based">
<h3>SKBuild vs. External Implementations (CMake-Based)<a class="headerlink" href="#skbuild-vs-external-implementations-cmake-based" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Aspect</p></th>
<th class="head"><p>External Implementations</p></th>
<th class="head"><p>SKBuild</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Build Integration</strong></p></td>
<td><p>Automated via <code class="docutils literal notranslate"><span class="pre">build_and_copy.sh</span></code> called by <a class="reference external" href="http://setup.py">setup.py</a></p></td>
<td><p>Integrated with pip/setuptools</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Package Discovery</strong></p></td>
<td><p>Automated file copying via build script</p></td>
<td><p>Automatic package inclusion</p></td>
</tr>
<tr class="row-even"><td><p><strong>Development Workflow</strong></p></td>
<td><p>Single <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span></code> command (build script runs automatically)</p></td>
<td><p>Single <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span></code> command</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Complexity</strong></p></td>
<td><p>Medium to High (automated build script + <a class="reference external" href="http://setup.py">setup.py</a> integration)</p></td>
<td><p>Medium (CMake + Python integration)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Use Case</strong></p></td>
<td><p>Complex external projects with custom build procedures</p></td>
<td><p>CMake-based Python extensions</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Build Scripts</strong></p></td>
<td><p>Required custom <code class="docutils literal notranslate"><span class="pre">build_and_copy.sh</span></code></p></td>
<td><p>No custom scripts needed</p></td>
</tr>
<tr class="row-even"><td><p><strong>File Management</strong></p></td>
<td><p>Copying of <code class="docutils literal notranslate"><span class="pre">.so</span></code> files via build script</p></td>
<td><p>Automatic placement in package</p></td>
</tr>
</tbody>
</table>
</section>
<section id="skbuild-vs-external-implementations-workflow-comparison">
<h3>SKBuild vs. External Implementations: Workflow Comparison<a class="headerlink" href="#skbuild-vs-external-implementations-workflow-comparison" title="Link to this heading"></a></h3>
<section id="external-implementations-workflow">
<h4>External Implementations Workflow:<a class="headerlink" href="#external-implementations-workflow" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Single step - setup.py automatically calls build_and_copy.sh</span>
<span class="nb">cd</span><span class="w"> </span>packages/example_package
pip<span class="w"> </span>install<span class="w"> </span><span class="o">{</span>-e<span class="o">}</span><span class="w"> </span>.<span class="w"> </span>--no-build-isolation
</pre></div>
</div>
</section>
<section id="skbuild-workflow">
<h4>SKBuild Workflow:<a class="headerlink" href="#skbuild-workflow" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Single step - SKBuild handles everything</span>
<span class="nb">cd</span><span class="w"> </span>packages/example_skbuild_package
pip<span class="w"> </span>install<span class="w"> </span>.<span class="w"> </span>--no-build-isolation
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong></strong><code class="docutils literal notranslate"><span class="pre">{-e}</span></code> means that this argument is optional. It is not present in the SKBuild-based example as
SKBuild does not support editable installs.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong></strong>Both approaches use a single <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span></code> command. The difference is that external implementations
automatically execute the <code class="docutils literal notranslate"><span class="pre">build_and_copy.sh</span></code> script during the setup process, while SKBuild handles the CMake
build process internally.</p>
</div>
</section>
</section>
<section id="when-to-use-skbuild-vs-external-implementations">
<h3>When to Use SKBuild vs. External Implementations<a class="headerlink" href="#when-to-use-skbuild-vs-external-implementations" title="Link to this heading"></a></h3>
<p><strong>Use SKBuild when:</strong></p>
<ul class="simple">
<li><p>You have CMake-based C++/CUDA code that you want to integrate as Python extensions</p></li>
<li><p>You want to avoid writing custom build scripts and rely on SKBuild’s built-in CMake integration</p></li>
<li><p>You prefer a more standardized approach to CMake-based Python packaging</p></li>
<li><p>You want to leverage CMake’s features while maintaining Python packaging standards</p></li>
</ul>
<p><strong>Use External Implementations when:</strong></p>
<ul class="simple">
<li><p>You want to use CMakeLists for parts of the implementation while defining PyTorch extensions directly in
<code class="docutils literal notranslate"><span class="pre">setup.py</span></code></p></li>
<li><p>You have very complex external projects with their own build systems</p></li>
<li><p>You need to integrate with third-party libraries that require specific build procedures</p></li>
<li><p>You want maximum flexibility in build configuration and file placement</p></li>
<li><p>You have existing build scripts that you want to preserve and integrate</p></li>
<li><p>You need to build components that exist outside the Python package structure</p></li>
<li><p>You require custom build steps that go beyond standard CMake workflows</p></li>
</ul>
</section>
</section>
<section id="the-build-configuration-system">
<h2>The Build Configuration System<a class="headerlink" href="#the-build-configuration-system" title="Link to this heading"></a></h2>
<p>ACCV-Lab uses a centralized build configuration provided by the <code class="docutils literal notranslate"><span class="pre">accvlab_build_config</span></code> package to ensure
consistency across packages and simplify adding new ones.</p>
<section id="installation">
<h3>Installation<a class="headerlink" href="#installation" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">build_config</span></code> package is a build dependency of the contained namespace packages. It is installed as part
of the ACCV-Lab installation using the unified installer script. However, it can also be built and installed
manually as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>build_config
<span class="c1"># Inside the build_config directory, call:</span>
pip<span class="w"> </span>install<span class="w"> </span>.<span class="w"> </span>--no-build-isolation
</pre></div>
</div>
</section>
<section id="purpose-and-benefits">
<h3>Purpose and Benefits<a class="headerlink" href="#purpose-and-benefits" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">build_config/</span></code> package serves several key purposes:</p>
<ol class="arabic simple">
<li><p><strong>Shared Build Utilities</strong>: Provides common functions for C++/CUDA extension building, dependency
management, and configuration handling</p></li>
<li><p><strong>Consistency</strong>: Ensures all namespace packages use the same build logic, compiler flags, and configuration
patterns</p></li>
<li><p><strong>Maintainability</strong>: Centralizes build logic so bug fixes and improvements benefit all packages</p></li>
<li><p><strong>Simplicity</strong>: Reduces amount of boilerplate code needed in the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> files of individual packages</p></li>
</ol>
</section>
<section id="shared-build-configuration-utilities">
<h3>Shared Build &amp; Configuration Utilities<a class="headerlink" href="#shared-build-configuration-utilities" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">accvlab_build_config</span></code> package provides the following shared build &amp; configuration utilities:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">load_config()</span></code> - Loads build configuration from environment variables (shared across all build types).
Please see the <a class="reference internal" href="INSTALLATION_GUIDE.html#available-build-variables"><span class="std std-ref">Available Build Variables</span></a> section of the
<a class="reference internal" href="INSTALLATION_GUIDE.html"><span class="std std-doc">Installation Guide</span></a> for the list of the supported variables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">detect_cuda_info()</span></code> - Detects CUDA availability and version</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_compile_flags()</span></code> - Generates compiler flags for PyTorch extensions; based on the variable values
obtained from <code class="docutils literal notranslate"><span class="pre">load_config()</span></code>. The generated flags can then be passed to the PyTorch extensions (see
example below).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">build_cmake_args_from_env()</span></code> - Translates the variable values obtained from <code class="docutils literal notranslate"><span class="pre">load_config()</span></code> into CMake <code class="docutils literal notranslate"><span class="pre">-D</span></code>
arguments for scikit-build and external CMake builds. The mappings are as follows:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">DEBUG_BUILD</span></code> → <code class="docutils literal notranslate"><span class="pre">CMAKE_BUILD_TYPE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CPP_STANDARD</span></code> → <code class="docutils literal notranslate"><span class="pre">CMAKE_CXX_STANDARD</span></code>, <code class="docutils literal notranslate"><span class="pre">CMAKE_CUDA_STANDARD</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CUSTOM_CUDA_ARCHS</span></code> → <code class="docutils literal notranslate"><span class="pre">CMAKE_CUDA_ARCHITECTURES</span></code> (auto-detect if unset)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VERBOSE_BUILD</span></code> → <code class="docutils literal notranslate"><span class="pre">CMAKE_VERBOSE_MAKEFILE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OPTIMIZE_LEVEL</span></code>, <code class="docutils literal notranslate"><span class="pre">USE_FAST_MATH</span></code>, <code class="docutils literal notranslate"><span class="pre">ENABLE_PROFILING</span></code> → appended to <code class="docutils literal notranslate"><span class="pre">CMAKE_CXX_FLAGS</span></code>, <code class="docutils literal notranslate"><span class="pre">CMAKE_CUDA_FLAGS</span></code></p></li>
<li><p>Always sets <code class="docutils literal notranslate"><span class="pre">-DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_external_build()</span></code> - Executes <code class="docutils literal notranslate"><span class="pre">build_and_copy.sh</span></code> build script (used in external implementations, see
<a class="reference internal" href="#external-implementations">External Implementations</a> section for more details).</p></li>
</ul>
</section>
<section id="usage-in-namespace-packages">
<h3>Usage in Namespace Packages<a class="headerlink" href="#usage-in-namespace-packages" title="Link to this heading"></a></h3>
<p>Each namespace package’s <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> imports and uses these shared utilities, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.cpp_extension</span><span class="w"> </span><span class="kn">import</span> <span class="n">BuildExtension</span><span class="p">,</span> <span class="n">CppExtension</span><span class="p">,</span> <span class="n">CUDAExtension</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">accvlab_build_config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">load_config</span><span class="p">,</span>
    <span class="n">detect_cuda_info</span><span class="p">,</span>
    <span class="n">get_compile_flags</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Load config and generate flags</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>
<span class="n">cuda_info</span> <span class="o">=</span> <span class="n">detect_cuda_info</span><span class="p">()</span>
<span class="n">compile_flags</span> <span class="o">=</span> <span class="n">get_compile_flags</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">cuda_info</span><span class="p">)</span>

<span class="c1"># Example: wire flags into extensions</span>
<span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">CppExtension</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;accvlab.&lt;pkg&gt;._cpp&quot;</span><span class="p">,</span>
        <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accvlab/&lt;pkg&gt;/csrc/cpp_functions.cpp&quot;</span><span class="p">],</span>
        <span class="n">extra_compile_args</span><span class="o">=</span><span class="n">compile_flags</span><span class="p">[</span><span class="s1">&#39;cxx&#39;</span><span class="p">],</span>
        <span class="n">language</span><span class="o">=</span><span class="s2">&quot;c++&quot;</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;VERBOSE_BUILD&quot;</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="n">CUDAExtension</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;accvlab.&lt;pkg&gt;._cuda&quot;</span><span class="p">,</span>
        <span class="n">sources</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;accvlab/&lt;pkg&gt;/csrc/cuda_functions.cpp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;accvlab/&lt;pkg&gt;/csrc/cuda_functions.cu&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">extra_compile_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cxx&quot;</span><span class="p">:</span> <span class="n">compile_flags</span><span class="p">[</span><span class="s2">&quot;cxx&quot;</span><span class="p">],</span> <span class="s2">&quot;nvcc&quot;</span><span class="p">:</span> <span class="n">compile_flags</span><span class="p">[</span><span class="s2">&quot;nvcc&quot;</span><span class="p">]},</span>
        <span class="n">language</span><span class="o">=</span><span class="s2">&quot;c++&quot;</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;VERBOSE_BUILD&quot;</span><span class="p">],</span>
    <span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>This approach ensures that:</p>
<ul class="simple">
<li><p>All packages use the same build logic</p></li>
<li><p>Configuration is consistent across packages</p></li>
<li><p>Build improvements benefit all packages automatically</p></li>
<li><p>Individual package <a class="reference external" href="http://setup.py">setup.py</a> files remain simple and focused</p></li>
</ul>
<p>Please see the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> files of the example packages (e.g. <code class="docutils literal notranslate"><span class="pre">packages/example_package/setup.py</span></code> and
<code class="docutils literal notranslate"><span class="pre">packages/example_skbuild_package/setup.py</span></code>) for complete working examples for different package types.</p>
</section>
<section id="how-build-variables-are-picked-up">
<h3>How Build Variables Are Picked Up<a class="headerlink" href="#how-build-variables-are-picked-up" title="Link to this heading"></a></h3>
<p>Depending on the package type, build variables are consumed as follows:</p>
<ul>
<li><p>Setuptools (PyTorch extensions):</p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, call <code class="docutils literal notranslate"><span class="pre">config</span> <span class="pre">=</span> <span class="pre">load_config()</span></code> and <code class="docutils literal notranslate"><span class="pre">cuda_info</span> <span class="pre">=</span> <span class="pre">detect_cuda_info()</span></code>, then pass
<code class="docutils literal notranslate"><span class="pre">compile_flags</span> <span class="pre">=</span> <span class="pre">get_compile_flags(config,</span> <span class="pre">cuda_info)</span></code> to <code class="docutils literal notranslate"><span class="pre">CppExtension</span></code>/<code class="docutils literal notranslate"><span class="pre">CUDAExtension</span></code>:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>
<span class="n">cuda_info</span> <span class="o">=</span> <span class="n">detect_cuda_info</span><span class="p">()</span>
<span class="n">compile_flags</span> <span class="o">=</span> <span class="n">get_compile_flags</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">cuda_info</span><span class="p">)</span>
<span class="n">ext</span> <span class="o">=</span> <span class="n">CUDAExtension</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;accvlab.&lt;pkg&gt;._ext&#39;</span><span class="p">,</span>
    <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>
    <span class="n">extra_compile_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cxx&#39;</span><span class="p">:</span> <span class="n">compile_flags</span><span class="p">[</span><span class="s1">&#39;cxx&#39;</span><span class="p">],</span> <span class="s1">&#39;nvcc&#39;</span><span class="p">:</span> <span class="n">compile_flags</span><span class="p">[</span><span class="s1">&#39;nvcc&#39;</span><span class="p">]},</span>
    <span class="n">language</span><span class="o">=</span><span class="s1">&#39;c++&#39;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;VERBOSE_BUILD&#39;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>This forwards <code class="docutils literal notranslate"><span class="pre">DEBUG_BUILD</span></code>, <code class="docutils literal notranslate"><span class="pre">OPTIMIZE_LEVEL</span></code>, <code class="docutils literal notranslate"><span class="pre">CPP_STANDARD</span></code>, <code class="docutils literal notranslate"><span class="pre">VERBOSE_BUILD</span></code>, <code class="docutils literal notranslate"><span class="pre">CUSTOM_CUDA_ARCHS</span></code>,
<code class="docutils literal notranslate"><span class="pre">USE_FAST_MATH</span></code>, and <code class="docutils literal notranslate"><span class="pre">ENABLE_PROFILING</span></code> to host and device compilers.</p></li>
</ul>
</li>
<li><p>External implementation (manual CMake):</p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">ext_impl/build_and_copy.sh</span></code>, forward variables using the helper to produce <code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">-D</span></code> args:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>readarray<span class="w"> </span>-t<span class="w"> </span>CMAKE_ARGS<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from accvlab_build_config.helpers.cmake_args import build_cmake_args_from_env; print(&#39;\n&#39;.join(build_cmake_args_from_env()))&quot;</span><span class="o">)</span>
cmake<span class="w"> </span>..<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CMAKE_ARGS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>...
cmake<span class="w"> </span>--build<span class="w"> </span>.<span class="w"> </span>--parallel
</pre></div>
</div>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>, avoid hardcoding and guard defaults so passed values win:</p></li>
</ul>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="s">DEFINED</span><span class="w"> </span><span class="s">CMAKE_CXX_STANDARD</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span><span class="w"> </span><span class="s">17</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="s">DEFINED</span><span class="w"> </span><span class="s">CMAKE_CUDA_ARCHITECTURES</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CUDA_ARCHITECTURES</span><span class="w"> </span><span class="s">native</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Scikit-build packages:</p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, pass CMake arguments from the helper:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">accvlab_build_config.helpers.cmake_args</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_cmake_args_from_env</span>
<span class="n">_cmake_args</span> <span class="o">=</span> <span class="n">build_cmake_args_from_env</span><span class="p">()</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">cmake_source_dir</span><span class="o">=</span><span class="s2">&quot;ext_impl&quot;</span><span class="p">,</span>
    <span class="n">cmake_install_dir</span><span class="o">=</span><span class="s2">&quot;accvlab/&lt;pkg&gt;&quot;</span><span class="p">,</span>
    <span class="n">cmake_args</span><span class="o">=</span><span class="n">_cmake_args</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">ext_impl/CMakeLists.txt</span></code>, guard defaults:</p></li>
</ul>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="s">DEFINED</span><span class="w"> </span><span class="s">CMAKE_CXX_STANDARD</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span><span class="w"> </span><span class="s">17</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="s">DEFINED</span><span class="w"> </span><span class="s">CMAKE_CUDA_ARCHITECTURES</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CUDA_ARCHITECTURES</span><span class="w"> </span><span class="s">native</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="configuration-options">
<h3>Configuration Options<a class="headerlink" href="#configuration-options" title="Link to this heading"></a></h3>
<p>For the list of supported environment variables, their defaults, and descriptions, see the
<a class="reference internal" href="INSTALLATION_GUIDE.html#available-build-variables"><span class="std std-ref">Available Build Variables</span></a> in the installation guide.
These variables can be set per-package during installation or globally for all packages.</p>
</section>
</section>
<section id="development-workflow">
<h2>Development Workflow<a class="headerlink" href="#development-workflow" title="Link to this heading"></a></h2>
<section id="testing-during-development">
<h3>Testing During Development<a class="headerlink" href="#testing-during-development" title="Link to this heading"></a></h3>
<section id="running-tests">
<h4>Running Tests<a class="headerlink" href="#running-tests" title="Link to this heading"></a></h4>
<p>Tests of a package can be performed with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>packages/&lt;package_name&gt;/tests
pytest<span class="w"> </span>.
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong></strong>Note that the tests do not necessarily need to be run from within the <code class="docutils literal notranslate"><span class="pre">tests</span></code> directory.
However, it is advised to not run tests from the root directory of a namespace package (i.e.
not from <code class="docutils literal notranslate"><span class="pre">packages/&lt;package_name&gt;</span></code>, as in this way, importing the package is ambiguous.
For example, the import <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">accvlab.&lt;package_name&gt;</span></code> could mean either refer to the installed package,
or to the original source files inside the current directory).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong></strong>See the section <a class="reference internal" href="#repository-test-runner-scripts-run-tests-sh">Repository test runner</a> for how to run
tests across all packages in the repository.</p>
</div>
</section>
<section id="install-in-development-mode">
<h4>Install in Development Mode<a class="headerlink" href="#install-in-development-mode" title="Link to this heading"></a></h4>
<p>This can be done with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.<span class="w"> </span>--no-build-isolation
</pre></div>
</div>
<p>Note that</p>
<ul class="simple">
<li><p>The editable mode refers to the Python code. For any changes in C++ code to take effect, the package
needs to be re-installed regardless whether it is installed in editable mode or not.</p></li>
<li><p>SKBuild does not support editable installs, and instead, the SKBuild-based packages need to be
always be installed without the <code class="docutils literal notranslate"><span class="pre">-e</span></code> flag.</p></li>
</ul>
</section>
</section>
<section id="documentation-development">
<h3>Documentation Development<a class="headerlink" href="#documentation-development" title="Link to this heading"></a></h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong></strong>Ensure all configured namespace packages are installed before building the docs.
For detailed instructions (commands and development targets), see the
<a class="reference internal" href="DOCUMENTATION_SETUP_GUIDE.html#building-documentation-locally"><span class="std std-ref">Documentation Setup Guide</span></a>.</p>
</div>
</section>
</section>
<section id="code-formatting">
<h2>Code Formatting<a class="headerlink" href="#code-formatting" title="Link to this heading"></a></h2>
<p>The ACCV-Lab project uses automated code formatting to maintain consistent code style across all namespace
packages. Please see the <a class="reference internal" href="FORMATTING_GUIDE.html"><span class="std std-doc">Formatting Guide</span></a> for details.</p>
<section id="script-features">
<h3>Script Features<a class="headerlink" href="#script-features" title="Link to this heading"></a></h3>
<p>As all scripts, the formatting script automatically discovers configured namespace packages from
<code class="docutils literal notranslate"><span class="pre">namespace_packages_config.py</span></code>.</p>
<p>Formatting for the whole repo can be run as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash<span class="w"> </span>scripts/format.sh
</pre></div>
</div>
<p>It is also possible to run the formatting for individual namespace packages. To list available packages and
format one of them:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># List available namespace packages</span>
python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from namespace_packages_config import get_package_names; print(&#39;\n&#39;.join(get_package_names()))&quot;</span>

<span class="c1"># Format a specific package (example)</span>
./scripts/format.sh<span class="w"> </span>--package<span class="w"> </span>on_demand_video_decoder
</pre></div>
</div>
<p>You can also format only a specific language:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Format Python code only (common + all packages)</span>
./scripts/format.sh<span class="w"> </span>--python

<span class="c1"># Format C++/CUDA code only (all packages)</span>
./scripts/format.sh<span class="w"> </span>--cpp

<span class="c1"># Combine with a package filter</span>
./scripts/format.sh<span class="w"> </span>--python<span class="w"> </span>--package<span class="w"> </span>example_package
./scripts/format.sh<span class="w"> </span>--cpp<span class="w"> </span>--package<span class="w"> </span>batching_helpers
</pre></div>
</div>
</section>
<section id="typical-workflows">
<h3>Typical Workflows<a class="headerlink" href="#typical-workflows" title="Link to this heading"></a></h3>
<section id="during-development">
<h4>During Development<a class="headerlink" href="#during-development" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Format the namespace package you&#39;re working on</span>
./scripts/format.sh<span class="w"> </span>--package<span class="w"> </span>example_package
</pre></div>
</div>
</section>
<section id="before-committing">
<h4>Before Committing<a class="headerlink" href="#before-committing" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Format everything to ensure consistency</span>
./scripts/format.sh
</pre></div>
</div>
</section>
</section>
</section>
<section id="repository-test-runner-scripts-run-tests-sh">
<h2>Repository Test Runner (<code class="docutils literal notranslate"><span class="pre">scripts/run_tests.sh</span></code>)<a class="headerlink" href="#repository-test-runner-scripts-run-tests-sh" title="Link to this heading"></a></h2>
<p>The repository provides a convenience script to run pytest for all configured namespace packages:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./scripts/run_tests.sh<span class="w">              </span><span class="c1"># run all tests</span>
./scripts/run_tests.sh<span class="w"> </span>--<span class="w"> </span>-k<span class="w"> </span>smoke<span class="w">  </span><span class="c1"># pass arguments after -- directly to pytest (`-k smoke` used as an example)</span>
</pre></div>
</div>
<p>How it discovers and runs tests:</p>
<ul class="simple">
<li><p>Discovers package names from <code class="docutils literal notranslate"><span class="pre">namespace_packages_config.py</span></code> (function <code class="docutils literal notranslate"><span class="pre">get_package_names()</span></code>).</p></li>
<li><p>For each package <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;</span></code>, looks for <code class="docutils literal notranslate"><span class="pre">packages/&lt;name&gt;/tests</span></code>. If missing, it warns and skips.</p></li>
<li><p>Executes <code class="docutils literal notranslate"><span class="pre">pytest</span></code> from inside each <code class="docutils literal notranslate"><span class="pre">packages/&lt;name&gt;/tests</span></code> directory to avoid importing local sources.</p></li>
<li><p>Exits non-zero if any package test run fails.</p></li>
</ul>
<p>To ensure your tests are picked up:</p>
<ul class="simple">
<li><p>Place tests under <code class="docutils literal notranslate"><span class="pre">packages/&lt;package_name&gt;/tests</span></code>.</p></li>
<li><p>Name files following pytest conventions (e.g., <code class="docutils literal notranslate"><span class="pre">test_*.py</span></code> or <code class="docutils literal notranslate"><span class="pre">*_test.py</span></code>).</p></li>
<li><p>If you need custom pytest flags, pass them after <code class="docutils literal notranslate"><span class="pre">--</span></code>, e.g.
<code class="docutils literal notranslate"><span class="pre">./scripts/run_tests.sh</span> <span class="pre">--</span> <span class="pre">-q</span> <span class="pre">-k</span> <span class="pre">&quot;gpu</span> <span class="pre">and</span> <span class="pre">not</span> <span class="pre">slow&quot;</span></code>.</p></li>
</ul>
<p>Additional notes:</p>
<ul class="simple">
<li><p>Inside your test scripts, import the installed package (e.g., <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">accvlab.&lt;package_name&gt;</span></code>), not local
source paths.</p></li>
<li><p>Ensure the package is installed in the current environment before running the script (editable or standard
install). This can be done with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-e</span> <span class="pre">.[optional]</span> <span class="pre">--no-build-isolation</span></code> or
<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">.[optional]</span> <span class="pre">--no-build-isolation</span></code> (see the Installation Guide for more details). Note that for
SKBuild-based packages, the editable install is not supported and will result in missing binaries &amp; import
errors.</p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong></strong>The tests often rely on optional dependencies. Therefore, it is recommended to install
the package with optional dependencies, as described in the <a class="reference internal" href="INSTALLATION_GUIDE.html"><span class="std std-doc">Installation Guide</span></a>.</p>
</div>
</section>
<section id="namespace-package-structure-and-configuration">
<h2>Namespace Package Structure and Configuration<a class="headerlink" href="#namespace-package-structure-and-configuration" title="Link to this heading"></a></h2>
<section id="understanding-the-package-structure">
<h3>Understanding the Package Structure<a class="headerlink" href="#understanding-the-package-structure" title="Link to this heading"></a></h3>
<p>ACCV-Lab uses implicit namespace packages where each package directory maps to a namespace under <code class="docutils literal notranslate"><span class="pre">accvlab</span></code>.
For example:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">packages/example_package/accvlab/example_package/</span></code> → <code class="docutils literal notranslate"><span class="pre">accvlab.example_package</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">packages/batching_helpers/accvlab/batching_helpers/</span></code> → <code class="docutils literal notranslate"><span class="pre">accvlab.batching_helpers</span></code></p></li>
</ul>
<p>Note that e.g. the directory <code class="docutils literal notranslate"><span class="pre">packages/example_package/</span></code> is the root directory of the package, containing
the <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> files, external C++ implementations or CMake projects as used by SKBuild,
documentation, etc. The remainder of the path (i.e. <code class="docutils literal notranslate"><span class="pre">[...]/accvlab/example_package/</span></code>) reflects the package
name as installed (<code class="docutils literal notranslate"><span class="pre">accvlab.example_package</span></code> in this case) and contains the actual Python package
implementation as will be included in the installation.</p>
</section>
<section id="id1">
<h3>Package Discovery Configuration<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> configuration is crucial for proper package discovery:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[tool.setuptools.packages.find]</span>
<span class="n">where</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">]</span>
<span class="n">include</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;accvlab.example_package*&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>This configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">where</span> <span class="pre">=</span> <span class="pre">[&quot;.&quot;]</span></code> - Searches in the current directory</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">include</span> <span class="pre">=</span> <span class="pre">[&quot;accvlab.example_package*&quot;]</span></code> - Includes all packages starting with <code class="docutils literal notranslate"><span class="pre">accvlab.example_package</span></code></p></li>
</ul>
</section>
<section id="handling-subpackages">
<h3>Handling Subpackages<a class="headerlink" href="#handling-subpackages" title="Link to this heading"></a></h3>
<p>If your namespace package contains subpackages (like <code class="docutils literal notranslate"><span class="pre">accvlab.example_package.functions</span></code>), the
<code class="docutils literal notranslate"><span class="pre">include</span> <span class="pre">=</span> <span class="pre">[&quot;accvlab.example_package*&quot;]</span></code> pattern will automatically discover and include all subpackages.</p>
</section>
<section id="notes">
<h3>Notes<a class="headerlink" href="#notes" title="Link to this heading"></a></h3>
<ol class="arabic">
<li><p><strong>Namespace package structure</strong>: The directory structure must match the namespace structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>packages/example_package/
├── accvlab/                    # ← Namespace root
│   └── example_package/       # Maps to accvlab.example_package
│       ├── __init__.py
│       ├── functions/         # Maps to accvlab.example_package.functions
│       │   └── __init__.py
│       └── ...
├── setup.py
├── pyproject.toml
└── ...
</pre></div>
</div>
</li>
<li><p>As usual for modules, <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> files need to be present and otherwise, e.g. the automatic package
discovery may fail.</p></li>
<li><p><strong>Build artifacts</strong>: Always clean build artifacts (<code class="docutils literal notranslate"><span class="pre">build/</span></code>, <code class="docutils literal notranslate"><span class="pre">dist/</span></code>, <code class="docutils literal notranslate"><span class="pre">*.egg-info/</span></code>) when testing package
installation to ensure that the installation can be performed from a clean state.</p></li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="DOCKER_GUIDE.html" class="btn btn-neutral float-left" title="Docker Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="FORMATTING_GUIDE.html" class="btn btn-neutral float-right" title="Code Formatting Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, NVIDIA Corporation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>